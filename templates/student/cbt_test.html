{% extends "base.html" %}

{% block title %}CBT Test - {{ subject.name }} - SMIED{% endblock %}

{% block content %}
<!-- Ensure hidden class works properly -->
<style>
    .question-container.hidden {
        display: none !important;
    }
    .question-container:not(.hidden) {
        display: block !important;
    }
</style>

<div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <!-- Test Header -->
    <div class="bg-white shadow-lg border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="h-12 w-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-laptop-code text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">{{ subject.name }} Practice Test</h1>
                        <p class="text-sm text-gray-600">{{ student.first_name }} {{ student.last_name }} - {{ student.student_id }}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Time Remaining</div>
                        <div id="timer" class="text-lg font-bold text-indigo-600">15:00</div>
                    </div>
                    <button id="submit-btn" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                        <i class="fas fa-check mr-1"></i>Submit Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
            <!-- Question Navigation -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">Question Navigation</h2>
                    <span class="text-sm text-gray-600">Question <span id="current-question">1</span> of {{ questions|length }}</span>
                </div>
                
                <!-- Question Navigation Buttons -->
                <div class="flex flex-wrap gap-2 mb-4">
                    {% for question in questions %}
                    <button class="question-nav-btn w-10 h-10 rounded-lg border-2 border-gray-300 text-gray-700 hover:border-indigo-500 hover:text-indigo-600 transition-colors duration-200" 
                            data-question="{{ loop.index0 }}">
                        {{ loop.index }}
                    </button>
                    {% endfor %}
                </div>
                
                <!-- Navigation Controls -->
                <div class="flex justify-between items-center">
                    <button id="prev-btn" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed">
                        <i class="fas fa-arrow-left mr-2"></i>Previous
                    </button>
                    <button id="next-btn" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-lg transition-colors duration-200">
                        Next<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Questions Container -->
            <form id="test-form">
                {% if questions and questions|length > 0 %}
                    {% for question in questions %}
                    <div class="question-container {% if loop.index0 != 0 %}hidden{% endif %}" data-question="{{ loop.index0 }}">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">
                                Question {{ loop.index }}: {{ question.question }}
                            </h3>
                        
                            <div class="space-y-3">
                                {% for option in question.options %}
                                <label class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition-all duration-200">
                                <input type="radio" 
                                       name="question_{{ question.id }}" 
                                       value="{{ loop.index0 }}" 
                                       class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"
                                       data-question-index="{{ loop.index0 }}">
                                    <span class="ml-3 text-gray-900 font-medium">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-2xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No Questions Available</h3>
                        <p class="text-gray-500">There are no questions available for this subject at the moment.</p>
                    </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div id="results-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                <i class="fas fa-check text-green-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-2">Test Completed!</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Your Score: <span id="final-score" class="font-bold text-indigo-600">0/0</span>
                    (<span id="percentage" class="font-bold text-indigo-600">0%</span>)
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button id="review-btn" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 mr-2">
                    Review Answers
                </button>
                <button id="close-btn" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentQuestionIndex = 0;
let totalQuestions = {{ questions|length }};
let timeRemaining = 15 * 60; // 15 minutes in seconds
let timerInterval;
let answeredQuestions = new Set();

// Make questions data available to JavaScript
window.questions = {{ questions|tojson|safe }};

// Initialize test
document.addEventListener('DOMContentLoaded', function() {
    console.log('CBT Test Initialization');
    console.log('Total questions:', totalQuestions);
    
    if (totalQuestions === 0) {
        console.error('No questions loaded!');
        return;
    }
    
    // Start timer
    startTimer();
    
    // Set up event listeners
    setupEventListeners();
    
    // Update navigation buttons
    updateNavigationButtons();
    updateQuestionNavButtons();
    
    console.log('CBT Test initialized successfully');
});

function startTimer() {
    timerInterval = setInterval(function() {
        timeRemaining--;
        
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        
        document.getElementById('timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            submitTest();
        }
    }, 1000);
}

function goToQuestion(index) {
    console.log('Going to question:', index);
    
    // Validate index
    if (index < 0 || index >= totalQuestions) {
        console.error('Invalid question index:', index);
        return;
    }
    
    // Hide all questions
    const questionContainers = document.querySelectorAll('.question-container');
    questionContainers.forEach(q => {
        q.classList.add('hidden');
    });
    
    // Show target question
    const targetQuestion = questionContainers[index];
    if (targetQuestion) {
        targetQuestion.classList.remove('hidden');
        console.log('Question', index, 'shown');
    } else {
        console.error('Question not found at index:', index);
        return;
    }
    
    // Update current question index
    currentQuestionIndex = index;
    
    // Update question counter
    document.getElementById('current-question').textContent = index + 1;
    
    // Update navigation buttons
    updateNavigationButtons();
    updateQuestionNavButtons();
}

function nextQuestion() {
    console.log('Next question called, current:', currentQuestionIndex);
    if (currentQuestionIndex < totalQuestions - 1) {
        goToQuestion(currentQuestionIndex + 1);
    } else {
        console.log('Already at last question');
    }
}

function previousQuestion() {
    console.log('Previous question called, current:', currentQuestionIndex);
    if (currentQuestionIndex > 0) {
        goToQuestion(currentQuestionIndex - 1);
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (prevBtn) {
        prevBtn.disabled = currentQuestionIndex === 0;
        if (currentQuestionIndex === 0) {
            prevBtn.classList.add('opacity-50', 'cursor-not-allowed');
        } else {
            prevBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        }
    }
    
    if (nextBtn) {
        // Don't disable the button on last question - it should be clickable to submit
        if (currentQuestionIndex === totalQuestions - 1) {
            nextBtn.innerHTML = 'Submit<i class="fas fa-check ml-2"></i>';
            nextBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            nextBtn.classList.remove('bg-indigo-500', 'hover:bg-indigo-600');
            nextBtn.disabled = false; // Ensure it's clickable
        } else {
            nextBtn.innerHTML = 'Next<i class="fas fa-arrow-right ml-2"></i>';
            nextBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
            nextBtn.classList.add('bg-indigo-500', 'hover:bg-indigo-600');
            nextBtn.disabled = false;
        }
    }
}

function updateQuestionNavButtons() {
    document.querySelectorAll('.question-nav-btn').forEach(btn => {
        const questionIndex = parseInt(btn.dataset.question);
        if (questionIndex === currentQuestionIndex) {
            btn.classList.add('bg-indigo-500', 'text-white', 'border-indigo-500');
        } else if (answeredQuestions.has(questionIndex)) {
            btn.classList.add('bg-green-500', 'text-white', 'border-green-500');
        } else {
            btn.classList.remove('bg-indigo-500', 'text-white', 'border-indigo-500', 'bg-green-500', 'border-green-500');
        }
    });
}

function markQuestionAnswered(questionIndex) {
    answeredQuestions.add(questionIndex);
    updateQuestionNavButtons();
}

function submitTest() {
    console.log('Submit test function called');
    clearInterval(timerInterval);
    
    // Calculate score
    let correctAnswers = 0;
    const form = document.getElementById('test-form');
    const formData = new FormData(form);
    
    // Get all answered questions and check against correct answers
    const answeredQuestions = new Set();
    for (let [name, value] of formData.entries()) {
        if (name.startsWith('question_')) {
            const questionId = name.replace('question_', '');
            const selectedOption = parseInt(value);
            answeredQuestions.add(questionId);
            
            // Check if answer is correct (assuming questions array is available)
            if (window.questions && window.questions[questionId - 1]) {
                const question = window.questions[questionId - 1];
                if (selectedOption === question.correct) {
                    correctAnswers++;
                    console.log(`Question ${questionId}: Correct!`);
                } else {
                    console.log(`Question ${questionId}: Incorrect. Selected: ${selectedOption}, Correct: ${question.correct}`);
                }
            }
        }
    }
    
    console.log('Total answered questions:', answeredQuestions.size);
    console.log('Correct answers:', correctAnswers);
    
    // Show results
    document.getElementById('final-score').textContent = `${correctAnswers}/${totalQuestions}`;
    document.getElementById('percentage').textContent = `${Math.round((correctAnswers / totalQuestions) * 100)}%`;
    document.getElementById('results-modal').classList.remove('hidden');
}

function reviewAnswers() {
    console.log('Review answers clicked');
    
    // Hide results modal
    document.getElementById('results-modal').classList.add('hidden');
    
    // Show review mode
    showAnswerReview();
}

function showAnswerReview() {
    // Create review overlay
    const reviewOverlay = document.createElement('div');
    reviewOverlay.id = 'review-overlay';
    reviewOverlay.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
    
    reviewOverlay.innerHTML = `
        <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-900">Answer Review</h2>
                    <button id="close-review" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                </div>
                
                <div id="review-content" class="space-y-6">
                    <!-- Review content will be generated here -->
                </div>
                
                <div class="mt-6 flex justify-end space-x-4">
                    <button id="back-to-results" class="bg-indigo-500 text-white px-6 py-2 rounded-lg hover:bg-indigo-600">
                        Back to Results
                    </button>
                    <button id="close-review-btn" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600">
                        Close
                    </button>
                </div>
            </div>
        </div>
    `;
    
    document.body.appendChild(reviewOverlay);
    
    // Generate review content
    generateReviewContent();
    
    // Add event listeners
    document.getElementById('close-review').addEventListener('click', closeReview);
    document.getElementById('close-review-btn').addEventListener('click', closeReview);
    document.getElementById('back-to-results').addEventListener('click', backToResults);
}

function generateReviewContent() {
    const reviewContent = document.getElementById('review-content');
    const form = document.getElementById('test-form');
    const formData = new FormData(form);
    
    let reviewHTML = '';
    
    // Get user answers
    const userAnswers = {};
    for (let [name, value] of formData.entries()) {
        if (name.startsWith('question_')) {
            const questionId = name.replace('question_', '');
            userAnswers[questionId] = parseInt(value);
        }
    }
    
    // Generate review for each question
    window.questions.forEach((question, index) => {
        const questionId = question.id;
        const userAnswer = userAnswers[questionId];
        const correctAnswer = question.correct;
        const isCorrect = userAnswer === correctAnswer;
        
        reviewHTML += `
            <div class="border border-gray-200 rounded-lg p-4 ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                <div class="flex items-start justify-between mb-3">
                    <h3 class="text-lg font-semibold text-gray-900">Question ${index + 1}</h3>
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${isCorrect ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${isCorrect ? 'Correct' : 'Incorrect'}
                    </span>
                </div>
                
                <p class="text-gray-800 mb-4">${question.question}</p>
                
                <div class="space-y-2">
                    ${question.options.map((option, optionIndex) => {
                        let optionClass = 'p-3 rounded-lg border';
                        let optionText = option;
                        
                        if (optionIndex === correctAnswer) {
                            optionClass += ' bg-green-100 border-green-300 text-green-800';
                            optionText += ' ✓ (Correct Answer)';
                        } else if (optionIndex === userAnswer) {
                            optionClass += ' bg-red-100 border-red-300 text-red-800';
                            optionText += ' ✗ (Your Answer)';
                        } else {
                            optionClass += ' bg-gray-50 border-gray-200 text-gray-700';
                        }
                        
                        return `<div class="${optionClass}">${optionText}</div>`;
                    }).join('')}
                </div>
                
                ${question.explanation ? `<div class="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <p class="text-sm text-blue-800"><strong>Explanation:</strong> ${question.explanation}</p>
                </div>` : ''}
            </div>
        `;
    });
    
    reviewContent.innerHTML = reviewHTML;
}

function closeReview() {
    const reviewOverlay = document.getElementById('review-overlay');
    if (reviewOverlay) {
        reviewOverlay.remove();
    }
}

function backToResults() {
    closeReview();
    document.getElementById('results-modal').classList.remove('hidden');
}

function closeResults() {
    document.getElementById('results-modal').classList.add('hidden');
    // Redirect to practice page or dashboard
    window.location.href = '/student/cbt-practice';
}

function setupEventListeners() {
    // Radio button change events
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const questionIndex = currentQuestionIndex;
            markQuestionAnswered(questionIndex);
        });
    });
    
    // Question navigation button events
    document.querySelectorAll('.question-nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const questionIndex = parseInt(this.dataset.question);
            goToQuestion(questionIndex);
        });
    });
    
    // Navigation control buttons
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const submitBtn = document.getElementById('submit-btn');
    const reviewBtn = document.getElementById('review-btn');
    const closeBtn = document.getElementById('close-btn');
    
    if (prevBtn) {
        prevBtn.addEventListener('click', function(e) {
            e.preventDefault();
            previousQuestion();
        });
    }
    
    if (nextBtn) {
        nextBtn.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('Next/Submit button clicked, current question:', currentQuestionIndex, 'total:', totalQuestions);
            if (currentQuestionIndex === totalQuestions - 1) {
                console.log('Calling submitTest()');
                submitTest();
            } else {
                console.log('Calling nextQuestion()');
                nextQuestion();
            }
        });
    }
    
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            e.preventDefault();
            submitTest();
        });
    }
    
    if (reviewBtn) {
        reviewBtn.addEventListener('click', function(e) {
            e.preventDefault();
            reviewAnswers();
        });
    }
    
    if (closeBtn) {
        closeBtn.addEventListener('click', function(e) {
            e.preventDefault();
            closeResults();
        });
    }
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft' && currentQuestionIndex > 0) {
        previousQuestion();
    } else if (e.key === 'ArrowRight' && currentQuestionIndex < totalQuestions - 1) {
        nextQuestion();
    }
});
</script>
{% endblock %}
