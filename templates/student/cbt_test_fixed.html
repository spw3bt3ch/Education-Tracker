{% extends "base.html" %}

{% block title %}CBT Test - {{ subject.name }} - SMIED{% endblock %}

{% block content %}
<!-- Ensure hidden class works properly -->
<style>
    .question-container.hidden {
        display: none !important;
    }
    .question-container:not(.hidden) {
        display: block !important;
    }
</style>

<div class="min-h-screen bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50">
    <!-- Test Header -->
    <div class="bg-white shadow-lg border-b border-gray-200 sticky top-0 z-10">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-4">
                    <div class="h-12 w-12 bg-gradient-to-r from-indigo-500 to-purple-600 rounded-full flex items-center justify-center">
                        <i class="fas fa-laptop-code text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-bold text-gray-900">{{ subject.name }} Practice Test</h1>
                        <p class="text-sm text-gray-600">{{ student.first_name }} {{ student.last_name }} - {{ student.student_id }}</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-600">Time Remaining</div>
                        <div id="timer" class="text-lg font-bold text-indigo-600">15:00</div>
                    </div>
                    <button onclick="submitTest()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg transition-colors duration-200">
                        <i class="fas fa-check mr-1"></i>Submit Test
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Test Content -->
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <div class="bg-white rounded-2xl shadow-xl p-8 border border-gray-100">
            <!-- Question Navigation -->
            <div class="mb-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-lg font-semibold text-gray-900">Question Navigation</h2>
                    <span class="text-sm text-gray-600">Question <span id="current-question">1</span> of {{ questions|length }}</span>
                </div>
                
                <!-- Question Navigation Buttons -->
                <div class="flex flex-wrap gap-2 mb-4">
                    {% for question in questions %}
                    <button class="question-nav-btn w-10 h-10 rounded-lg border-2 border-gray-300 text-gray-700 hover:border-indigo-500 hover:text-indigo-600 transition-colors duration-200" 
                            data-question="{{ loop.index0 }}">
                        {{ loop.index }}
                    </button>
                    {% endfor %}
                </div>
                
                <!-- Navigation Controls -->
                <div class="flex justify-between items-center">
                    <button id="prev-btn" onclick="previousQuestion()" class="bg-gray-500 hover:bg-gray-600 text-white px-6 py-2 rounded-lg transition-colors duration-200 disabled:bg-gray-300 disabled:cursor-not-allowed">
                        <i class="fas fa-arrow-left mr-2"></i>Previous
                    </button>
                    <button id="next-btn" onclick="nextQuestion()" class="bg-indigo-500 hover:bg-indigo-600 text-white px-6 py-2 rounded-lg transition-colors duration-200">
                        Next<i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- Questions Container -->
            <form id="test-form">
                {% if questions and questions|length > 0 %}
                    {% for question in questions %}
                    <div class="question-container {% if loop.index0 != 0 %}hidden{% endif %}" data-question="{{ loop.index0 }}">
                        <div class="mb-6">
                            <h3 class="text-xl font-bold text-gray-900 mb-4">
                                Question {{ loop.index }}: {{ question.question }}
                            </h3>
                        
                            <div class="space-y-3">
                                {% for option in question.options %}
                                <label class="flex items-center p-4 border border-gray-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-300 cursor-pointer transition-all duration-200">
                                <input type="radio" 
                                       name="question_{{ question.id }}" 
                                       value="{{ loop.index0 }}" 
                                       class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300"
                                       data-question-index="{{ loop.index0 }}">
                                    <span class="ml-3 text-gray-900 font-medium">{{ option }}</span>
                                </label>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="text-center py-12">
                        <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-2xl text-gray-400"></i>
                        </div>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">No Questions Available</h3>
                        <p class="text-gray-500">There are no questions available for this subject at the moment.</p>
                    </div>
                {% endif %}
            </form>
        </div>
    </div>
</div>

<!-- Results Modal -->
<div id="results-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-green-100">
                <i class="fas fa-check text-green-600 text-xl"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mt-2">Test Completed!</h3>
            <div class="mt-2 px-7 py-3">
                <p class="text-sm text-gray-500">
                    Your Score: <span id="final-score" class="font-bold text-indigo-600">0/0</span>
                    (<span id="percentage" class="font-bold text-indigo-600">0%</span>)
                </p>
            </div>
            <div class="items-center px-4 py-3">
                <button onclick="reviewAnswers()" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 mr-2">
                    Review Answers
                </button>
                <button onclick="closeResults()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

<script>
let currentQuestionIndex = 0;
let totalQuestions = {{ questions|length }};
let timeRemaining = 15 * 60; // 15 minutes in seconds
let timerInterval;
let answeredQuestions = new Set();

// Initialize test
document.addEventListener('DOMContentLoaded', function() {
    console.log('CBT Test Initialization');
    console.log('Total questions:', totalQuestions);
    
    if (totalQuestions === 0) {
        console.error('No questions loaded!');
        return;
    }
    
    // Start timer
    startTimer();
    
    // Set up event listeners
    setupEventListeners();
    
    // Update navigation buttons
    updateNavigationButtons();
    updateQuestionNavButtons();
    
    console.log('CBT Test initialized successfully');
});

function startTimer() {
    timerInterval = setInterval(function() {
        timeRemaining--;
        
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        
        document.getElementById('timer').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        
        if (timeRemaining <= 0) {
            clearInterval(timerInterval);
            submitTest();
        }
    }, 1000);
}

function goToQuestion(index) {
    console.log('Going to question:', index);
    
    // Validate index
    if (index < 0 || index >= totalQuestions) {
        console.error('Invalid question index:', index);
        return;
    }
    
    // Hide all questions
    const questionContainers = document.querySelectorAll('.question-container');
    questionContainers.forEach(q => {
        q.classList.add('hidden');
    });
    
    // Show target question
    const targetQuestion = questionContainers[index];
    if (targetQuestion) {
        targetQuestion.classList.remove('hidden');
        console.log('Question', index, 'shown');
    } else {
        console.error('Question not found at index:', index);
        return;
    }
    
    // Update current question index
    currentQuestionIndex = index;
    
    // Update question counter
    document.getElementById('current-question').textContent = index + 1;
    
    // Update navigation buttons
    updateNavigationButtons();
    updateQuestionNavButtons();
}

function nextQuestion() {
    console.log('Next question called, current:', currentQuestionIndex);
    if (currentQuestionIndex < totalQuestions - 1) {
        goToQuestion(currentQuestionIndex + 1);
    } else {
        console.log('Already at last question');
    }
}

function previousQuestion() {
    console.log('Previous question called, current:', currentQuestionIndex);
    if (currentQuestionIndex > 0) {
        goToQuestion(currentQuestionIndex - 1);
    }
}

function updateNavigationButtons() {
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (prevBtn) {
        prevBtn.disabled = currentQuestionIndex === 0;
    }
    
    if (nextBtn) {
        nextBtn.disabled = currentQuestionIndex === totalQuestions - 1;
        
        if (currentQuestionIndex === totalQuestions - 1) {
            nextBtn.innerHTML = 'Submit<i class="fas fa-check ml-2"></i>';
        } else {
            nextBtn.innerHTML = 'Next<i class="fas fa-arrow-right ml-2"></i>';
        }
    }
}

function updateQuestionNavButtons() {
    document.querySelectorAll('.question-nav-btn').forEach(btn => {
        const questionIndex = parseInt(btn.dataset.question);
        if (questionIndex === currentQuestionIndex) {
            btn.classList.add('bg-indigo-500', 'text-white', 'border-indigo-500');
        } else if (answeredQuestions.has(questionIndex)) {
            btn.classList.add('bg-green-500', 'text-white', 'border-green-500');
        } else {
            btn.classList.remove('bg-indigo-500', 'text-white', 'border-indigo-500', 'bg-green-500', 'border-green-500');
        }
    });
}

function markQuestionAnswered(questionIndex) {
    answeredQuestions.add(questionIndex);
    updateQuestionNavButtons();
}

function submitTest() {
    clearInterval(timerInterval);
    
    // Calculate score
    let correctAnswers = 0;
    const form = document.getElementById('test-form');
    const formData = new FormData(form);
    
    // This is a simplified scoring - you may need to implement proper answer checking
    correctAnswers = formData.getAll('question_').length;
    
    // Show results
    document.getElementById('final-score').textContent = `${correctAnswers}/${totalQuestions}`;
    document.getElementById('percentage').textContent = `${Math.round((correctAnswers / totalQuestions) * 100)}%`;
    document.getElementById('results-modal').classList.remove('hidden');
}

function reviewAnswers() {
    // Implement answer review functionality
    console.log('Review answers clicked');
}

function closeResults() {
    document.getElementById('results-modal').classList.add('hidden');
    // Redirect to practice page or dashboard
    window.location.href = '/student/cbt-practice';
}

function setupEventListeners() {
    // Radio button change events
    document.querySelectorAll('input[type="radio"]').forEach(radio => {
        radio.addEventListener('change', function() {
            const questionIndex = parseInt(this.dataset.questionIndex);
            markQuestionAnswered(questionIndex);
        });
    });
    
    // Question navigation button events
    document.querySelectorAll('.question-nav-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const questionIndex = parseInt(this.dataset.question);
            goToQuestion(questionIndex);
        });
    });
}

// Keyboard shortcuts
document.addEventListener('keydown', function(e) {
    if (e.key === 'ArrowLeft' && currentQuestionIndex > 0) {
        previousQuestion();
    } else if (e.key === 'ArrowRight' && currentQuestionIndex < totalQuestions - 1) {
        nextQuestion();
    }
});
</script>
{% endblock %}
