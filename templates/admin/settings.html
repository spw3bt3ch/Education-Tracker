{% extends "base.html" %}

{% block title %}Settings - EduTrack{% endblock %}

{% block content %}
<style>
.nav-link {
    position: relative;
}
.nav-link.active {
    background-color: var(--primary-color, #3B82F6) !important;
    color: white !important;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}
.nav-link.active:hover {
    background-color: var(--primary-color, #3B82F6) !important;
    color: white !important;
}
.settings-section {
    min-height: 500px;
}
</style>

<div class="flex justify-between items-center mb-8">
    <h1 class="text-3xl font-bold text-gray-900 flex items-center">
        <i class="fas fa-cog mr-3"></i>System Settings
    </h1>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    <!-- Settings Navigation -->
    <div class="bg-white rounded-xl shadow-lg p-6">
        <h2 class="text-lg font-semibold text-gray-900 mb-4">Settings Categories</h2>
        <nav class="space-y-1">
            <a href="#school-info" onclick="showSection('school-info')" class="nav-link block px-4 py-3 text-sm font-medium text-primary bg-primary bg-opacity-10 rounded-lg transition-all duration-200 hover:bg-opacity-20">
                <i class="fas fa-school mr-3"></i>School Information
            </a>
            <a href="#color-theme" onclick="showSection('color-theme')" class="nav-link block px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-100 hover:text-primary rounded-lg transition-all duration-200">
                <i class="fas fa-palette mr-3"></i>Color Theme
            </a>
            <a href="#user-management" onclick="showSection('user-management')" class="nav-link block px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-100 hover:text-primary rounded-lg transition-all duration-200">
                <i class="fas fa-users mr-3"></i>User Management
            </a>
            <a href="#notifications" onclick="showSection('notifications')" class="nav-link block px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-100 hover:text-primary rounded-lg transition-all duration-200">
                <i class="fas fa-bell mr-3"></i>Notifications
            </a>
            <a href="#security" onclick="showSection('security')" class="nav-link block px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-100 hover:text-primary rounded-lg transition-all duration-200">
                <i class="fas fa-shield-alt mr-3"></i>Security
            </a>
            <a href="#backup" onclick="showSection('backup')" class="nav-link block px-4 py-3 text-sm font-medium text-gray-700 hover:bg-gray-100 hover:text-primary rounded-lg transition-all duration-200">
                <i class="fas fa-database mr-3"></i>Backup & Restore
            </a>
        </nav>
    </div>

    <!-- Settings Content -->
    <div class="lg:col-span-2">
        <!-- School Information Section -->
        <div id="school-info" class="settings-section bg-white rounded-xl shadow-lg p-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">School Information</h2>
            
            <form method="POST" class="space-y-6" id="school-info-form">
                <input type="hidden" name="form_type" value="school_info">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="school_name" class="block text-sm font-medium text-gray-700 mb-2">School Name</label>
                        <input type="text" id="school_name" name="school_name" value="{{ settings.school_name }}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div>
                        <label for="school_code" class="block text-sm font-medium text-gray-700 mb-2">School Code</label>
                        <input type="text" id="school_code" name="school_code" value="{{ settings.school_code }}" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>

                <div>
                    <label for="school_address" class="block text-sm font-medium text-gray-700 mb-2">School Address</label>
                    <textarea id="school_address" name="school_address" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="Enter complete school address">{{ settings.school_address }}</textarea>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="school_phone" class="block text-sm font-medium text-gray-700 mb-2">School Phone Number</label>
                        <input type="tel" id="school_phone" name="school_phone" value="{{ settings.school_phone }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="e.g., +234 123 456 7890">
                    </div>
                    <div>
                        <label for="school_email" class="block text-sm font-medium text-gray-700 mb-2">School Email Address</label>
                        <input type="email" id="school_email" name="school_email" value="{{ settings.school_email }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="e.g., info@schoolname.edu">
                    </div>
                </div>

                <div>
                    <label for="school_website" class="block text-sm font-medium text-gray-700 mb-2">School Website</label>
                    <input type="text" id="school_website" name="school_website" value="{{ settings.school_website }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="e.g., https://www.schoolname.edu or www.schoolname.edu">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="academic_year" class="block text-sm font-medium text-gray-700 mb-2">Academic Year</label>
                        <input type="text" id="academic_year" name="academic_year" value="{{ settings.academic_year }}" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                    <div>
                        <label for="max_students_per_class" class="block text-sm font-medium text-gray-700 mb-2">Max Students per Class</label>
                        <input type="number" id="max_students_per_class" name="max_students_per_class" value="{{ settings.max_students_per_class }}" min="1" max="50" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                    </div>
                </div>

                <!-- Auto Backup Settings -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Auto Backup Settings</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="auto_backup_enabled" class="flex items-center">
                                <input type="checkbox" id="auto_backup_enabled" name="auto_backup_enabled" {% if settings.auto_backup_enabled %}checked{% endif %} class="mr-2 rounded border-gray-300 text-primary focus:ring-primary">
                                <span class="text-sm font-medium text-gray-700">Enable Auto Backup</span>
                            </label>
                            <p class="text-xs text-gray-500 mt-1">Automatically create backups at scheduled intervals</p>
                        </div>
                        <div>
                            <label for="auto_backup_frequency" class="block text-sm font-medium text-gray-700 mb-2">Backup Frequency</label>
                            <select id="auto_backup_frequency" name="auto_backup_frequency" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="daily" {% if settings.auto_backup_frequency == 'daily' %}selected{% endif %}>Daily</option>
                                <option value="weekly" {% if settings.auto_backup_frequency == 'weekly' %}selected{% endif %}>Weekly</option>
                                <option value="monthly" {% if settings.auto_backup_frequency == 'monthly' %}selected{% endif %}>Monthly</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="auto_backup_time" class="block text-sm font-medium text-gray-700 mb-2">Backup Time (24-hour format)</label>
                        <input type="time" id="auto_backup_time" name="auto_backup_time" value="{{ settings.auto_backup_time or '02:00' }}" class="w-full md:w-48 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Time when automatic backups should be created</p>
                    </div>
                    <div class="mt-4">
                        <label for="auto_backup_retention" class="block text-sm font-medium text-gray-700 mb-2">Backup Retention (days)</label>
                        <input type="number" id="auto_backup_retention" name="auto_backup_retention" value="{{ settings.auto_backup_retention or 30 }}" min="1" max="365" class="w-full md:w-48 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <p class="text-xs text-gray-500 mt-1">Number of days to keep automatic backups (older backups will be deleted)</p>
                    </div>
                </div>

                <div class="flex justify-end space-x-4">
                    <button type="button" onclick="resetForm()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition duration-200">
                        Reset
                    </button>
                    <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition duration-200">
                        <i class="fas fa-save mr-2"></i>Save Changes
                    </button>
                </div>
            </form>
        </div>

        <!-- User Management Section -->
        <div id="user-management" class="settings-section bg-white rounded-xl shadow-lg p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">User Management</h2>
            <div class="space-y-4">
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div>
                        <h3 class="font-medium text-gray-900">Password Policy</h3>
                        <p class="text-sm text-gray-600">Configure password requirements for all users</p>
                    </div>
                    <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition duration-200">
                        Configure
                    </button>
                </div>
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div>
                        <h3 class="font-medium text-gray-900">User Roles</h3>
                        <p class="text-sm text-gray-600">Manage user roles and permissions</p>
                    </div>
                    <button class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition duration-200">
                        Manage
                    </button>
                </div>
            </div>
        </div>

        <!-- Notifications Section -->
        <div id="notifications" class="settings-section bg-white rounded-xl shadow-lg p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Notification Settings</h2>
            <form class="space-y-4">
                <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg">
                    <div>
                        <h3 class="font-medium text-gray-900">Email Notifications</h3>
                        <p class="text-sm text-gray-600">Send email notifications for important events</p>
                    </div>
                    <label class="relative inline-flex items-center cursor-pointer">
                        <input type="checkbox" name="notification_email" {% if settings.notification_email %}checked{% endif %} class="sr-only peer">
                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                    </label>
                </div>
                <div class="flex justify-end">
                    <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition duration-200">
                        Save Settings
                    </button>
                </div>
            </form>
        </div>

        <!-- Color Theme Section -->
        <div id="color-theme" class="settings-section bg-white rounded-xl shadow-lg p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Color Theme Settings</h2>
            <p class="text-gray-600 mb-6">Customize the color scheme for your school. These settings will apply to all dashboards (Admin, Teachers, and Parents).</p>
            
            <form method="POST" action="{{ url_for('update_settings') }}" class="space-y-6" id="color-theme-form">
                <input type="hidden" name="form_type" value="color_theme">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div>
                        <label for="primary_color" class="block text-sm font-medium text-gray-700 mb-2">Primary Color</label>
                        <div class="flex items-center space-x-3">
                            <input type="color" id="primary_color" name="primary_color" value="{{ settings.primary_color }}" class="w-12 h-10 border border-gray-300 rounded-lg cursor-pointer">
                            <input type="text" id="primary_color_text" value="{{ settings.primary_color }}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="#3B82F6">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Main brand color for buttons, links, and highlights</p>
                    </div>
                    
                    <div>
                        <label for="secondary_color" class="block text-sm font-medium text-gray-700 mb-2">Secondary Color</label>
                        <div class="flex items-center space-x-3">
                            <input type="color" id="secondary_color" name="secondary_color" value="{{ settings.secondary_color }}" class="w-12 h-10 border border-gray-300 rounded-lg cursor-pointer">
                            <input type="text" id="secondary_color_text" value="{{ settings.secondary_color }}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="#6B7280">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Secondary elements and text</p>
                    </div>
                    
                    <div>
                        <label for="accent_color" class="block text-sm font-medium text-gray-700 mb-2">Accent Color</label>
                        <div class="flex items-center space-x-3">
                            <input type="color" id="accent_color" name="accent_color" value="{{ settings.accent_color }}" class="w-12 h-10 border border-gray-300 rounded-lg cursor-pointer">
                            <input type="text" id="accent_color_text" value="{{ settings.accent_color }}" class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" placeholder="#10B981">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Success states and positive actions</p>
                    </div>
                </div>

                <div>
                    <label for="theme_mode" class="block text-sm font-medium text-gray-700 mb-2">Theme Mode</label>
                    <select id="theme_mode" name="theme_mode" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        <option value="light" {% if settings.theme_mode == 'light' %}selected{% endif %}>Light Mode</option>
                        <option value="dark" {% if settings.theme_mode == 'dark' %}selected{% endif %}>Dark Mode</option>
                        <option value="auto" {% if settings.theme_mode == 'auto' %}selected{% endif %}>Auto (System Preference)</option>
                    </select>
                    <p class="text-xs text-gray-500 mt-1">Choose the overall appearance theme</p>
                </div>

                <!-- Theme Preview -->
                <div class="border-t pt-6">
                    <h3 class="text-lg font-medium text-gray-900 mb-4">Theme Preview</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="p-4 border rounded-lg">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="w-3 h-3 rounded-full" style="background-color: {{ settings.primary_color }}"></div>
                                <span class="text-sm font-medium">Primary Color</span>
                            </div>
                            <button class="px-4 py-2 text-white rounded-lg text-sm" style="background-color: {{ settings.primary_color }}">Sample Button</button>
                        </div>
                        <div class="p-4 border rounded-lg">
                            <div class="flex items-center space-x-2 mb-2">
                                <div class="w-3 h-3 rounded-full" style="background-color: {{ settings.accent_color }}"></div>
                                <span class="text-sm font-medium">Accent Color</span>
                            </div>
                            <button class="px-4 py-2 text-white rounded-lg text-sm" style="background-color: {{ settings.accent_color }}">Success Button</button>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between">
                    <button type="button" onclick="event.preventDefault(); applyThemeNow(event);" class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-200">
                        <i class="fas fa-eye mr-2"></i>Preview Theme
                    </button>
                    <button type="submit" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-700 transition duration-200">
                        <i class="fas fa-save mr-2"></i>Save Theme Settings
                    </button>
                </div>
            </form>
        </div>

        <!-- Security Section -->
        <div id="security" class="settings-section bg-white rounded-xl shadow-lg p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Security Settings</h2>
            <div class="space-y-4">
                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <h3 class="font-medium text-yellow-800">Security Warning</h3>
                    <p class="text-sm text-yellow-700 mt-1">Security settings are critical for system protection. Changes should be made carefully.</p>
                </div>
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div>
                        <h3 class="font-medium text-gray-900">Session Timeout</h3>
                        <p class="text-sm text-gray-600">Configure automatic logout after inactivity</p>
                    </div>
                    <button class="px-4 py-2 bg-warning text-white rounded-lg hover:bg-yellow-700 transition duration-200">
                        Configure
                    </button>
                </div>
            </div>
        </div>

        <!-- Backup & Restore Section -->
        <div id="backup" class="settings-section bg-white rounded-xl shadow-lg p-6 hidden">
            <h2 class="text-xl font-semibold text-gray-900 mb-6">Backup & Restore</h2>
            <div class="space-y-6">
                <!-- Create New Backup -->
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div>
                        <h3 class="font-medium text-gray-900">Create New Backup</h3>
                        <p class="text-sm text-gray-600">Create and download a backup of all system data</p>
                    </div>
                    <a href="{{ url_for('backup_data') }}" class="px-4 py-2 bg-success text-white rounded-lg hover:bg-green-700 transition duration-200">
                        <i class="fas fa-download mr-2"></i>Create & Download
                    </a>
                </div>

                <!-- Auto Backup Status -->
                <div>
                    <h3 class="font-medium text-gray-900 mb-4">Auto Backup Status</h3>
                    <div id="auto-backup-status" class="p-4 bg-blue-50 rounded-lg">
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin text-blue-400 text-2xl mb-2"></i>
                            <p class="text-blue-500">Loading auto backup status...</p>
                        </div>
                    </div>
                </div>

                <!-- Available Backups -->
                <div>
                    <h3 class="font-medium text-gray-900 mb-4">Available Backups</h3>
                    <div id="backups-list" class="space-y-2">
                        <div class="text-center py-4">
                            <i class="fas fa-spinner fa-spin text-gray-400 text-2xl mb-2"></i>
                            <p class="text-gray-500">Loading backups...</p>
                        </div>
                    </div>
                </div>

                <!-- Restore Database -->
                <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg">
                    <div>
                        <h3 class="font-medium text-gray-900">Restore Database</h3>
                        <p class="text-sm text-gray-600">Restore from a previous backup</p>
                    </div>
                    <form method="POST" action="{{ url_for('restore_data') }}" class="inline">
                        <button type="submit" class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-red-700 transition duration-200" onclick="return confirm('Are you sure you want to restore the database? This action cannot be undone.')">
                            <i class="fas fa-upload mr-2"></i>Restore
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Navigation functionality
function showSection(sectionId) {
    // Hide all sections
    const sections = ['school-info', 'color-theme', 'user-management', 'notifications', 'security', 'backup'];
    sections.forEach(id => {
        const section = document.getElementById(id);
        if (section) {
            section.classList.add('hidden');
        }
    });
    
    // Show selected section
    const selectedSection = document.getElementById(sectionId);
    if (selectedSection) {
        selectedSection.classList.remove('hidden');
    }
    
    // Update navigation active state
    const navLinks = document.querySelectorAll('.nav-link');
    navLinks.forEach(link => {
        link.classList.remove('active', 'text-primary', 'bg-primary', 'bg-opacity-10', 'bg-opacity-20');
        link.classList.add('text-gray-700', 'hover:bg-gray-100', 'hover:text-primary');
    });
    
    const activeLink = document.querySelector(`a[href="#${sectionId}"]`);
    if (activeLink) {
        activeLink.classList.remove('text-gray-700', 'hover:bg-gray-100', 'hover:text-primary');
        activeLink.classList.add('active');
    }
}

// Form reset functionality
function resetForm() {
    const form = document.querySelector('form');
    if (form) {
        form.reset();
        // Reset to original values
        const originalValues = {
            'school_name': '{{ settings.school_name }}',
            'school_code': '{{ settings.school_code }}',
            'school_address': '{{ settings.school_address }}',
            'school_phone': '{{ settings.school_phone }}',
            'school_email': '{{ settings.school_email }}',
            'academic_year': '{{ settings.academic_year }}',
            'max_students_per_class': '{{ settings.max_students_per_class }}'
        };
        
        Object.keys(originalValues).forEach(key => {
            const input = document.getElementById(key);
            if (input) {
                input.value = originalValues[key];
            }
        });
    }
}

// Form validation
function validateWebsiteUrl(url) {
    if (!url) return true; // Allow empty values
    
    // Add http:// if no protocol is specified
    if (!url.startsWith('http://') && !url.startsWith('https://')) {
        return 'https://' + url;
    }
    return url;
}

// Load auto backup status
function loadAutoBackupStatus() {
    fetch('/admin/auto-backup/status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('auto-backup-status');
            const statusIcon = data.enabled ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500';
            const statusText = data.enabled ? 'Enabled' : 'Disabled';
            const statusColor = data.enabled ? 'text-green-600' : 'text-red-600';
            
            let nextRunText = '';
            if (data.next_run) {
                const nextRun = new Date(data.next_run);
                nextRunText = `Next run: ${nextRun.toLocaleString()}`;
            } else {
                nextRunText = 'No scheduled runs';
            }
            
            statusDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <i class="fas ${statusIcon} text-2xl"></i>
                        <div>
                            <p class="font-medium ${statusColor}">Auto Backup ${statusText}</p>
                            <p class="text-sm text-gray-600">
                                ${data.frequency} at ${data.backup_time} • 
                                ${data.auto_backup_count} auto backups • 
                                Keep ${data.retention_days} days
                            </p>
                            <p class="text-xs text-gray-500">${nextRunText}</p>
                        </div>
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="triggerAutoBackup()" 
                                class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition duration-200">
                            <i class="fas fa-play mr-1"></i>Run Now
                        </button>
                        <button onclick="loadAutoBackupStatus()" 
                                class="px-3 py-1 bg-gray-500 text-white text-sm rounded hover:bg-gray-600 transition duration-200">
                            <i class="fas fa-refresh mr-1"></i>Refresh
                        </button>
                    </div>
                </div>
            `;
        })
        .catch(error => {
            console.error('Error loading auto backup status:', error);
            document.getElementById('auto-backup-status').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle text-red-400 text-2xl mb-2"></i>
                    <p class="text-red-500">Error loading auto backup status</p>
                    <button onclick="loadAutoBackupStatus()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-200">
                        <i class="fas fa-refresh mr-2"></i>Retry
                    </button>
                </div>
            `;
        });
}

// Trigger auto backup manually
function triggerAutoBackup() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Running...';
    button.disabled = true;
    
    fetch('/admin/auto-backup/trigger', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Auto backup created successfully!');
            loadAutoBackupStatus();
            loadBackups(); // Refresh backup list
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error triggering auto backup:', error);
        alert('Error triggering auto backup');
    })
    .finally(() => {
        button.innerHTML = originalText;
        button.disabled = false;
    });
}

// Load available backups
function loadBackups() {
    fetch('/admin/backups')
        .then(response => response.json())
        .then(data => {
            const backupsList = document.getElementById('backups-list');
            if (data.backups && data.backups.length > 0) {
                backupsList.innerHTML = data.backups.map(backup => `
                    <div class="flex justify-between items-center p-3 bg-white border border-gray-200 rounded-lg">
                        <div class="flex-1">
                            <div class="flex items-center space-x-3">
                                <i class="fas fa-database text-blue-500"></i>
                                <div>
                                    <p class="font-medium text-gray-900">${backup.filename}</p>
                                    <p class="text-sm text-gray-500">
                                        ${new Date(backup.created).toLocaleString()} • ${backup.size_mb} MB
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="flex space-x-2">
                            <a href="/admin/backup/${backup.filename}" 
                               class="px-3 py-1 bg-blue-500 text-white text-sm rounded hover:bg-blue-600 transition duration-200">
                                <i class="fas fa-download mr-1"></i>Download
                            </a>
                        </div>
                    </div>
                `).join('');
            } else {
                backupsList.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-database text-gray-400 text-4xl mb-4"></i>
                        <p class="text-gray-500">No backups available</p>
                        <p class="text-sm text-gray-400">Create your first backup using the button above</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading backups:', error);
            document.getElementById('backups-list').innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-red-400 text-4xl mb-4"></i>
                    <p class="text-red-500">Error loading backups</p>
                    <button onclick="loadBackups()" class="mt-2 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 transition duration-200">
                        <i class="fas fa-refresh mr-2"></i>Retry
                    </button>
                </div>
            `;
        });
}

// Add form submission handler
document.addEventListener('DOMContentLoaded', function() {
    // Show school-info section by default
    showSection('school-info');
    
    // Add form validation
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const websiteInput = document.getElementById('school_website');
            if (websiteInput && websiteInput.value.trim()) {
                const correctedUrl = validateWebsiteUrl(websiteInput.value.trim());
                websiteInput.value = correctedUrl;
            }
        });
    });
    
    // Load backups when backup section is shown
    const backupNavLink = document.querySelector('a[href="#backup"]');
    if (backupNavLink) {
        backupNavLink.addEventListener('click', function() {
            setTimeout(() => {
                loadBackups();
                loadAutoBackupStatus();
            }, 100); // Small delay to ensure section is visible
        });
    }
    
    // Handle initial page load with hash
    window.addEventListener('load', function() {
        const hash = window.location.hash.substring(1);
        if (hash && ['school-info', 'color-theme', 'user-management', 'notifications', 'security', 'backup'].includes(hash)) {
            showSection(hash);
        }
    });
    
    // Color picker synchronization and live preview
    const colorPickers = ['primary_color', 'secondary_color', 'accent_color'];
    colorPickers.forEach(colorName => {
        const colorPicker = document.getElementById(colorName);
        const textInput = document.getElementById(colorName + '_text');
        
        if (colorPicker && textInput) {
            // Sync color picker to text input
            colorPicker.addEventListener('input', function() {
                textInput.value = this.value;
                updateThemePreview();
            });
            
            // Sync text input to color picker
            textInput.addEventListener('input', function() {
                if (this.value.match(/^#[0-9A-Fa-f]{6}$/)) {
                    colorPicker.value = this.value;
                    updateThemePreview();
                }
            });
        }
    });
    
    // Update theme preview in real-time
    function updateThemePreview() {
        const primaryColor = document.getElementById('primary_color').value;
        const accentColor = document.getElementById('accent_color').value;
        
        // Update preview elements
        const primaryPreview = document.querySelector('[style*="background-color: {{ settings.primary_color }}"]');
        const accentPreview = document.querySelector('[style*="background-color: {{ settings.accent_color }}"]');
        
        if (primaryPreview) {
            primaryPreview.style.backgroundColor = primaryColor;
        }
        if (accentPreview) {
            accentPreview.style.backgroundColor = accentColor;
        }
        
        // Update color dots
        const primaryDot = document.querySelector('.w-3.h-3.rounded-full[style*="background-color: {{ settings.primary_color }}"]');
        const accentDot = document.querySelector('.w-3.h-3.rounded-full[style*="background-color: {{ settings.accent_color }}"]');
        
        if (primaryDot) {
            primaryDot.style.backgroundColor = primaryColor;
        }
        if (accentDot) {
            accentDot.style.backgroundColor = accentColor;
        }
    }
    
    // Global function to apply theme (can be called from anywhere)
    window.applyThemeNow = function(event) {
        const primaryColor = document.getElementById('primary_color').value;
        const secondaryColor = document.getElementById('secondary_color').value;
        const accentColor = document.getElementById('accent_color').value;
        const themeMode = document.getElementById('theme_mode').value;
        
        console.log('Applying theme:', { primaryColor, secondaryColor, accentColor, themeMode });
        
        // Update Tailwind config
        if (window.tailwind) {
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            primary: primaryColor,
                            secondary: secondaryColor,
                            success: accentColor,
                            warning: '#F59E0B',
                            danger: '#EF4444',
                            info: '#06B6D4'
                        }
                    }
                }
            };
            
            // Force Tailwind to re-render
            if (window.tailwind.refresh) {
                window.tailwind.refresh();
            }
        }
        
        // Alternative approach: Create a style element with the new colors
        let styleElement = document.getElementById('dynamic-theme-styles');
        if (!styleElement) {
            styleElement = document.createElement('style');
            styleElement.id = 'dynamic-theme-styles';
            document.head.appendChild(styleElement);
        }
        
        styleElement.textContent = `
            .bg-primary { background-color: ${primaryColor} !important; }
            .text-primary { color: ${primaryColor} !important; }
            .border-primary { border-color: ${primaryColor} !important; }
            .ring-primary { --tw-ring-color: ${primaryColor} !important; }
            .bg-secondary { background-color: ${secondaryColor} !important; }
            .text-secondary { color: ${secondaryColor} !important; }
            .bg-success { background-color: ${accentColor} !important; }
            .text-success { color: ${accentColor} !important; }
            .border-success { border-color: ${accentColor} !important; }
        `;
        
        // Apply theme mode
        if (themeMode === 'dark') {
            document.documentElement.classList.add('dark');
        } else if (themeMode === 'light') {
            document.documentElement.classList.remove('dark');
        } else if (themeMode === 'auto') {
            // Auto mode - use system preference
            if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        }
        
        // Update CSS custom properties for immediate effect
        document.documentElement.style.setProperty('--primary-color', primaryColor);
        document.documentElement.style.setProperty('--secondary-color', secondaryColor);
        document.documentElement.style.setProperty('--accent-color', accentColor);
        
        // Force re-render of elements with primary color
        const primaryElements = document.querySelectorAll('.bg-primary, .text-primary, .border-primary, .ring-primary');
        primaryElements.forEach(el => {
            if (el.classList.contains('bg-primary')) {
                el.style.setProperty('background-color', primaryColor, 'important');
            }
            if (el.classList.contains('text-primary')) {
                el.style.setProperty('color', primaryColor, 'important');
            }
            if (el.classList.contains('border-primary')) {
                el.style.setProperty('border-color', primaryColor, 'important');
            }
            if (el.classList.contains('ring-primary')) {
                el.style.setProperty('--tw-ring-color', primaryColor, 'important');
            }
        });
        
        // Update success/accent color elements
        const successElements = document.querySelectorAll('.bg-success, .text-success, .border-success');
        successElements.forEach(el => {
            if (el.classList.contains('bg-success')) {
                el.style.setProperty('background-color', accentColor, 'important');
            }
            if (el.classList.contains('text-success')) {
                el.style.setProperty('color', accentColor, 'important');
            }
            if (el.classList.contains('border-success')) {
                el.style.setProperty('border-color', accentColor, 'important');
            }
        });
        
        // Update secondary color elements
        const secondaryElements = document.querySelectorAll('.bg-secondary, .text-secondary');
        secondaryElements.forEach(el => {
            if (el.classList.contains('bg-secondary')) {
                el.style.setProperty('background-color', secondaryColor, 'important');
            }
            if (el.classList.contains('text-secondary')) {
                el.style.setProperty('color', secondaryColor, 'important');
            }
        });
        
        // Show success message
        const button = event ? event.target : document.querySelector('button[onclick="applyThemeNow()"]');
        if (button) {
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-check mr-2"></i>Theme Applied!';
            button.classList.remove('bg-gray-500', 'hover:bg-gray-600');
            button.classList.add('bg-green-500', 'hover:bg-green-600');
            
            setTimeout(() => {
                button.innerHTML = originalText;
                button.classList.remove('bg-green-500', 'hover:bg-green-600');
                button.classList.add('bg-gray-500', 'hover:bg-gray-600');
            }, 2000);
        }
        
        console.log('Theme applied successfully');
    }
});
</script>
{% endblock %}
