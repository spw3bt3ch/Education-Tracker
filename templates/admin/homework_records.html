{% extends "base.html" %}

{% block title %}Homework Records - Admin Dashboard{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 sm:mb-8 space-y-2 sm:space-y-0">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center">
        <i class="fas fa-book-open mr-2 sm:mr-3"></i>Homework Records
    </h1>
    <div class="flex items-center space-x-3">
        <a href="{{ url_for('admin_send_message') }}" class="bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition duration-200 text-sm">
            <i class="fas fa-envelope mr-1"></i>Send Message
        </a>
        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary text-white">
            Head Teacher View
        </span>
    </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 sm:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
    <div class="bg-gradient-to-r from-primary to-blue-600 rounded-xl p-6 text-white shadow-lg">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-3xl font-bold">{{ homework_records|length }}</h3>
                <p class="text-blue-100">Total Records</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i class="fas fa-book-open text-2xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-gradient-to-r from-success to-green-600 rounded-xl p-6 text-white shadow-lg">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-3xl font-bold">{{ homework_records|groupby('teacher_id')|list|length }}</h3>
                <p class="text-green-100">Teachers Submitted</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i class="fas fa-chalkboard-user text-2xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-gradient-to-r from-info to-cyan-600 rounded-xl p-6 text-white shadow-lg">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-3xl font-bold">{{ homework_records|groupby('class_id')|list|length }}</h3>
                <p class="text-cyan-100">Classes Covered</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i class="fas fa-school text-2xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Filter Options -->
<div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6 sm:mb-8">
    <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
        <i class="fas fa-filter mr-2 text-primary"></i>Filter Records
    </h2>
    <form method="GET" class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div>
            <label for="weekFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Week</label>
            <select id="weekFilter" name="week_filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                <option value="">All Weeks</option>
                <option value="Week 1" {% if week_filter == 'Week 1' %}selected{% endif %}>Week 1</option>
                <option value="Week 2" {% if week_filter == 'Week 2' %}selected{% endif %}>Week 2</option>
                <option value="Week 3" {% if week_filter == 'Week 3' %}selected{% endif %}>Week 3</option>
                <option value="Week 4" {% if week_filter == 'Week 4' %}selected{% endif %}>Week 4</option>
                <option value="Week 5" {% if week_filter == 'Week 5' %}selected{% endif %}>Week 5</option>
                <option value="Week 6" {% if week_filter == 'Week 6' %}selected{% endif %}>Week 6</option>
                <option value="Week 7" {% if week_filter == 'Week 7' %}selected{% endif %}>Week 7</option>
                <option value="Week 8" {% if week_filter == 'Week 8' %}selected{% endif %}>Week 8</option>
                <option value="Week 9" {% if week_filter == 'Week 9' %}selected{% endif %}>Week 9</option>
                <option value="Week 10" {% if week_filter == 'Week 10' %}selected{% endif %}>Week 10</option>
                <option value="Week 11" {% if week_filter == 'Week 11' %}selected{% endif %}>Week 11</option>
                <option value="Week 12" {% if week_filter == 'Week 12' %}selected{% endif %}>Week 12</option>
                <option value="Week 13" {% if week_filter == 'Week 13' %}selected{% endif %}>Week 13</option>
            </select>
        </div>
        <div>
            <label for="teacherFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Teacher</label>
            <select id="teacherFilter" name="teacher_filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                <option value="">All Teachers</option>
                {% for record in homework_records|groupby('teacher.first_name') %}
                <option value="{{ record.list[0].teacher.id }}" {% if teacher_filter == record.list[0].teacher.id|string %}selected{% endif %}>{{ record.grouper }} {{ record.list[0].teacher.last_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label for="classFilter" class="block text-sm font-medium text-gray-700 mb-2">Filter by Class</label>
            <select id="classFilter" name="class_filter" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                <option value="">All Classes</option>
                {% for class in all_classes %}
                <option value="{{ class.id }}" {% if class_filter == class.id|string %}selected{% endif %}>{{ class.name }} (Basic {{ class.grade_level }})</option>
                {% endfor %}
            </select>
        </div>
        <div class="pt-6">
            <button type="submit" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 w-full">
                <i class="fas fa-search mr-1"></i>Apply Filter
            </button>
        </div>
    </form>
</div>

<!-- Homework Records Table -->
<div class="bg-white rounded-xl shadow-lg overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-list mr-2 text-primary"></i>All Homework Records
        </h2>
    </div>
    
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Week</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teacher</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Description</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date Submitted</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200" id="recordsTableBody">
                {% if homework_records %}
                    {% for record in homework_records %}
                    <tr class="hover:bg-gray-50" data-week="{{ record.week }}" data-teacher="{{ record.teacher.first_name }}" data-class="{{ record.class_obj.name }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">
                                {{ record.week }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="flex items-center">
                                <div class="w-8 h-8 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mr-3">
                                    <i class="fas fa-user text-primary text-sm"></i>
                                </div>
                                <div>
                                    <div class="font-medium">{{ record.teacher.first_name }} {{ record.teacher.last_name }}</div>
                                    <div class="text-gray-500">{{ record.teacher.email }}</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="font-medium">{{ record.class_obj.name }}</div>
                            <div class="text-gray-500">Basic {{ record.class_obj.grade_level }}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900">
                            <div class="max-w-xs truncate" title="{{ record.description }}">
                                {{ record.description[:100] }}{% if record.description|length > 100 %}...{% endif %}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                            {{ record.created_at.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <a href="{{ url_for('admin_view_homework_record', record_id=record.id) }}" class="text-primary hover:text-blue-700 mr-3" title="View Details">
                                <i class="fas fa-eye"></i>
                            </a>
                            <button class="text-info hover:text-cyan-700 mr-3" onclick="sendMessageToTeacher({{ record.teacher.id }}, '{{ record.teacher.first_name }} {{ record.teacher.last_name }}')" title="Send Message">
                                <i class="fas fa-envelope"></i>
                            </button>
                            <button class="text-success hover:text-green-700" onclick="downloadRecord({{ record.id }})" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="6" class="px-6 py-12 text-center">
                            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                <i class="fas fa-book-open text-2xl text-gray-400"></i>
                            </div>
                            <p class="text-gray-500 mb-4">No homework records submitted yet.</p>
                            <p class="text-sm text-gray-400">Records will appear here when teachers submit their homework records.</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal for viewing homework record details -->
<div id="viewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium text-gray-900">Homework Record Details</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            <div id="modalContent" class="space-y-4">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<script>
function downloadRecord(recordId) {
    // This would typically generate and download a PDF or document
    alert('Download functionality would be implemented here');
}

function sendMessageToTeacher(teacherId, teacherName) {
    // Redirect to send message page with pre-filled teacher
    window.location.href = `/admin/send-message?teacher_id=${teacherId}&teacher_name=${encodeURIComponent(teacherName)}`;
}

function closeModal() {
    document.getElementById('viewModal').classList.add('hidden');
}
</script>
{% endblock %}
