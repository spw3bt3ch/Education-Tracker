{% extends "base.html" %}

{% block title %}Admin Dashboard - SMIED{% endblock %}


{% block content %}
<!-- Welcome Section with Profile Picture -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6 sm:mb-8">
    <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-6">
        <!-- Profile Picture -->
        <div class="flex-shrink-0">
            {% if current_user.profile_picture %}
                <img src="{{ url_for('static', filename=current_user.profile_picture) }}" 
                     alt="Profile Picture" 
                     class="w-20 h-20 rounded-full object-cover border-4 border-primary shadow-lg">
            {% else %}
                <div class="w-20 h-20 bg-primary bg-opacity-10 rounded-full flex items-center justify-center border-4 border-primary shadow-lg">
                    <i class="fas fa-user text-3xl text-primary"></i>
                </div>
            {% endif %}
        </div>
        
        <!-- Welcome Text and Info -->
        <div class="flex-1 min-w-0">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">
                Welcome back, {{ current_user.first_name }}!
            </h1>
            <p class="text-gray-600 mb-3">Here's what's happening at your school today.</p>
            
            <!-- School Information - Prominently Displayed -->
            {% if current_user.school %}
            <div class="bg-gradient-to-r from-primary to-blue-600 rounded-lg p-4 mb-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold mb-1">
                            <i class="fas fa-school mr-2"></i>
                            {{ current_user.school.name }}
                        </h2>
                        {% if current_user.school.contact_email %}
                        <p class="text-blue-100 text-sm">
                            <i class="fas fa-envelope mr-1"></i>
                            {{ current_user.school.contact_email }}
                        </p>
                        {% endif %}
                        {% if current_user.school.address %}
                        <p class="text-blue-100 text-sm">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            {{ current_user.school.address }}
                        </p>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white bg-opacity-20 text-white">
                            <i class="fas fa-user-shield mr-1"></i>
                            School Administrator
                        </span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="flex flex-wrap items-center gap-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-primary text-white">
                    <i class="fas fa-user-shield mr-1"></i>
                    Head Teacher
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-700">
                    <i class="fas fa-school mr-1"></i>
                    School Admin
                </span>
            </div>
            {% endif %}

            <!-- Free Trial Countdown Timer -->
            {% if subscription_info and subscription_info.get('is_trial') %}
            <div class="bg-gradient-to-r from-yellow-400 to-orange-500 rounded-lg p-4 mb-6 text-white shadow-lg" 
                 data-end-date="{{ subscription_info.get('end_date').isoformat() }}">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <div class="bg-white bg-opacity-20 rounded-full p-3 mr-4">
                            <i class="fas fa-clock text-2xl"></i>
                        </div>
                        <div>
                            <h3 class="text-lg font-bold mb-1">
                                {{ subscription_info.get('plan_name') }} Expires Soon!
                            </h3>
                            <p class="text-yellow-100 text-sm">
                                Your free trial will end in:
                            </p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="countdown-timer" class="text-3xl font-bold font-mono">
                            <span id="days">--</span>d 
                            <span id="hours">--</span>h 
                            <span id="minutes">--</span>m 
                            <span id="seconds">--</span>s
                        </div>
                        <div class="text-yellow-100 text-sm mt-1">
                            <a href="/pricing" class="underline hover:text-white transition duration-150">
                                Upgrade Now
                            </a>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <div class="w-full bg-white bg-opacity-20 rounded-full h-2">
                        <div id="progress-bar" class="bg-white h-2 rounded-full transition-all duration-1000" 
                             style="width: {{ ((subscription_info.get('days_remaining', 0) / 7) * 100) if subscription_info.get('days_remaining', 0) <= 7 else 100 }}%"></div>
                    </div>
                    <div class="flex justify-between text-xs text-yellow-100 mt-1">
                        <span>Trial Started</span>
                        <span id="trial-end-date">{{ subscription_info.get('end_date').strftime('%B %d, %Y') }}</span>
                    </div>
                </div>
            </div>
            
            <!-- Countdown Timer JavaScript -->
            <script>
            document.addEventListener('DOMContentLoaded', function() {
                const countdownTimer = document.getElementById('countdown-timer');
                if (!countdownTimer) return;
                
                const countdownContainer = countdownTimer.closest('[data-end-date]');
                if (!countdownContainer) return;
                
                const endDate = new Date(countdownContainer.getAttribute('data-end-date')).getTime();
                
                function updateCountdown() {
                    const now = new Date().getTime();
                    const distance = endDate - now;
                    
                    if (distance < 0) {
                        document.getElementById('days').textContent = '00';
                        document.getElementById('hours').textContent = '00';
                        document.getElementById('minutes').textContent = '00';
                        document.getElementById('seconds').textContent = '00';
                        return;
                    }
                    
                    const days = Math.floor(distance / (1000 * 60 * 60 * 24));
                    const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    document.getElementById('days').textContent = days.toString().padStart(2, '0');
                    document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
                    document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
                    document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
                }
                
                updateCountdown();
                setInterval(updateCountdown, 1000);
            });
            </script>
            {% endif %}
        </div>
        
        <!-- Quick Stats -->
        <div class="flex-shrink-0 hidden sm:block">
            <div class="text-right">
                <div class="text-2xl font-bold text-primary">{{ total_students }}</div>
                <div class="text-sm text-gray-500">Students</div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions Section -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
        <i class="fas fa-bolt mr-2"></i>
        Quick Actions
    </h3>
    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
        <!-- Send Message to Teachers -->
        <a href="{{ url_for('admin_send_message') }}" class="bg-gradient-to-r from-primary to-blue-600 text-white p-4 rounded-lg hover:from-primary hover:to-blue-700 transition duration-200 flex items-center justify-center space-x-2">
            <i class="fas fa-chalkboard-teacher text-xl"></i>
            <span class="font-medium">Message Teachers</span>
        </a>
        
        <!-- Send Message to Parents -->
        <a href="{{ url_for('admin_send_message_to_parent') }}" class="bg-gradient-to-r from-info to-cyan-600 text-white p-4 rounded-lg hover:from-info hover:to-cyan-700 transition duration-200 flex items-center justify-center space-x-2">
            <i class="fas fa-user text-xl"></i>
            <span class="font-medium">Message Parents</span>
        </a>
        
        <!-- View Messages -->
        <a href="{{ url_for('admin_messages') }}" class="bg-gradient-to-r from-success to-green-600 text-white p-4 rounded-lg hover:from-success hover:to-green-700 transition duration-200 flex items-center justify-center space-x-2 relative">
            <i class="fas fa-inbox text-xl"></i>
            <span class="font-medium">View Messages</span>
            {% if unread_messages_count > 0 %}
            <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center font-bold">
                {{ unread_messages_count }}
            </span>
            {% endif %}
        </a>
        
        <!-- System Settings -->
        <a href="{{ url_for('system_settings') }}" class="bg-gradient-to-r from-warning to-yellow-600 text-white p-4 rounded-lg hover:from-warning hover:to-yellow-700 transition duration-200 flex items-center justify-center space-x-2">
            <i class="fas fa-cog text-xl"></i>
            <span class="font-medium">Settings</span>
        </a>
    </div>
</div>

<!-- Statistics Cards -->
<div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 sm:gap-6 mb-6 sm:mb-8">
    <div class="bg-gradient-to-r from-primary to-blue-600 rounded-xl p-6 text-white shadow-lg">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-3xl font-bold">{{ total_students }}</h3>
                <p class="text-blue-100">Total Students</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i class="fas fa-graduation-cap text-2xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-gradient-to-r from-success to-green-600 rounded-xl p-6 text-white shadow-lg">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-3xl font-bold">{{ total_teachers }}</h3>
                <p class="text-green-100">Teachers</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i class="fas fa-chalkboard-user text-2xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-gradient-to-r from-info to-cyan-600 rounded-xl p-6 text-white shadow-lg">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-3xl font-bold">{{ total_classes }}</h3>
                <p class="text-cyan-100">Classes</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i class="fas fa-school text-2xl"></i>
            </div>
        </div>
    </div>
    
    <div class="bg-gradient-to-r from-warning to-yellow-600 rounded-xl p-6 text-white shadow-lg">
        <div class="flex justify-between items-center">
            <div>
                <h3 class="text-3xl font-bold">{{ recent_assignments|length }}</h3>
                <p class="text-yellow-100">Recent Assignments</p>
            </div>
            <div class="w-12 h-12 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i class="fas fa-tasks text-2xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
        <i class="fas fa-bolt mr-2 text-warning"></i>Quick Actions
    </h2>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <a href="{{ url_for('manage_teachers') }}" class="group p-4 border border-gray-200 rounded-lg hover:border-primary hover:shadow-md transition-all duration-200">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-primary bg-opacity-10 rounded-lg flex items-center justify-center mr-3 group-hover:bg-primary group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-chalkboard-user text-white group-hover:text-white"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 group-hover:text-primary">Manage Teachers</span>
            </div>
        </a>
        
        <a href="{{ url_for('manage_classes') }}" class="group p-4 border border-gray-200 rounded-lg hover:border-success hover:shadow-md transition-all duration-200">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-success bg-opacity-10 rounded-lg flex items-center justify-center mr-3 group-hover:bg-success group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-school text-white group-hover:text-white"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 group-hover:text-success">Manage Classes</span>
            </div>
        </a>
        
        <a href="{{ url_for('admin_report_cards') }}" class="group p-4 border border-gray-200 rounded-lg hover:border-purple-500 hover:shadow-md transition-all duration-200">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-purple-500 bg-opacity-10 rounded-lg flex items-center justify-center mr-3 group-hover:bg-purple-500 group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-file-alt text-purple-500 group-hover:text-white"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 group-hover:text-purple-500">Report Cards</span>
            </div>
        </a>
        
        <a href="{{ url_for('admin_attendance') }}" class="group p-4 border border-gray-200 rounded-lg hover:border-orange-500 hover:shadow-md transition-all duration-200">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-orange-500 bg-opacity-10 rounded-lg flex items-center justify-center mr-3 group-hover:bg-orange-500 group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-calendar-check text-orange-500 group-hover:text-white"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 group-hover:text-orange-500">Attendance</span>
            </div>
        </a>
        
        <a href="{{ url_for('view_reports') }}" class="group p-4 border border-gray-200 rounded-lg hover:border-info hover:shadow-md transition-all duration-200">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-info bg-opacity-10 rounded-lg flex items-center justify-center mr-3 group-hover:bg-info group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-chart-bar text-info group-hover:text-white"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 group-hover:text-info">View Reports</span>
            </div>
        </a>
        
        <a href="{{ url_for('system_settings') }}" class="group p-4 border border-gray-200 rounded-lg hover:border-warning hover:shadow-md transition-all duration-200">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-warning bg-opacity-10 rounded-lg flex items-center justify-center mr-3 group-hover:bg-warning group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-cog text-warning group-hover:text-white"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 group-hover:text-warning">Settings</span>
            </div>
        </a>
        
        <a href="{{ url_for('admin_homework_records') }}" class="group p-4 border border-gray-200 rounded-lg hover:border-purple-500 hover:shadow-md transition-all duration-200">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-purple-500 bg-opacity-10 rounded-lg flex items-center justify-center mr-3 group-hover:bg-purple-500 group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-book-open text-purple-500 group-hover:text-white"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 group-hover:text-purple-500">Homework Records</span>
            </div>
        </a>
        
        <a href="{{ url_for('admin_teacher_submissions') }}" class="group p-4 border border-gray-200 rounded-lg hover:border-green-500 hover:shadow-md transition-all duration-200">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-green-500 bg-opacity-10 rounded-lg flex items-center justify-center mr-3 group-hover:bg-green-500 group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-clipboard-check text-green-500 group-hover:text-white"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 group-hover:text-green-500">Teacher Submissions</span>
            </div>
        </a>
        
        <a href="{{ url_for('admin_lesson_submissions') }}" class="group p-4 border border-gray-200 rounded-lg hover:border-indigo-500 hover:shadow-md transition-all duration-200">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-indigo-500 bg-opacity-10 rounded-lg flex items-center justify-center mr-3 group-hover:bg-indigo-500 group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-chalkboard text-indigo-500 group-hover:text-white"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 group-hover:text-indigo-500">View All Lessons</span>
            </div>
        </a>
        
        <a href="{{ url_for('admin_send_message') }}" class="group p-4 border border-gray-200 rounded-lg hover:border-orange-500 hover:shadow-md transition-all duration-200">
            <div class="flex items-center">
                <div class="w-10 h-10 bg-orange-500 bg-opacity-10 rounded-lg flex items-center justify-center mr-3 group-hover:bg-orange-500 group-hover:text-white transition-colors duration-200">
                    <i class="fas fa-envelope text-orange-500 group-hover:text-white"></i>
                </div>
                <span class="text-sm font-medium text-gray-700 group-hover:text-orange-500">Send Message</span>
            </div>
        </a>
    </div>
</div>

<!-- Teacher Submissions Overview -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-semibold text-gray-900 flex items-center">
            <i class="fas fa-clipboard-check mr-2 text-primary"></i>Teacher Submissions Overview
        </h2>
        <div class="flex space-x-2">
            <a href="{{ url_for('admin_lesson_submissions') }}" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition duration-200 text-sm">
                <i class="fas fa-chalkboard mr-1"></i>View All Lessons
            </a>
            <a href="{{ url_for('admin_homework_records') }}" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition duration-200 text-sm">
                <i class="fas fa-book-open mr-1"></i>View All Homework
            </a>
        </div>
    </div>
    
    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teacher</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Class</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Homework Records</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lesson Plans/Notes</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total Submissions</th>
                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-200">
                {% for teacher_data in teachers_with_submissions %}
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="w-10 h-10 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mr-3">
                                <i class="fas fa-user text-primary"></i>
                            </div>
                            <div>
                                <div class="text-sm font-medium text-gray-900">{{ teacher_data.teacher.first_name }} {{ teacher_data.teacher.last_name }}</div>
                                <div class="text-sm text-gray-500">{{ teacher_data.teacher.email }}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {% if teacher_data.teacher.classes %}
                            {% for class in teacher_data.teacher.classes %}
                                {{ class.name }}<br>
                            {% endfor %}
                        {% else %}
                            <span class="text-gray-400">No classes assigned</span>
                        {% endif %}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-teal-100 text-teal-800">
                            {{ teacher_data.homework_count }} records
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                            {{ teacher_data.lesson_count }} lessons
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">
                            {{ teacher_data.total_submissions }} total
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                        {% if teacher_data.total_submissions > 0 %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                <i class="fas fa-check-circle mr-1"></i>Active
                            </span>
                        {% else %}
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                                <i class="fas fa-exclamation-triangle mr-1"></i>No Submissions
                            </span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Notifications Section -->
<div class="bg-white rounded-xl shadow-lg mb-8">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-bell mr-2 text-orange-500"></i>Recent Notifications
                {% if unread_notifications_count > 0 %}
                    <span class="ml-2 inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">
                        {{ unread_notifications_count }} unread
                    </span>
                {% endif %}
            </h2>
            <a href="{{ url_for('admin_notifications') }}" class="text-sm text-primary hover:text-blue-700">
                View All Notifications
            </a>
        </div>
    </div>
    <div class="p-6">
        {% if recent_notifications %}
            <div class="space-y-4">
                {% for notification in recent_notifications %}
                <div class="flex items-start p-4 border border-gray-200 rounded-lg {% if not notification.is_read %}bg-blue-50 border-blue-200{% endif %}">
                    <div class="flex-shrink-0">
                        <div class="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center">
                            <i class="fas fa-envelope text-orange-600 text-sm"></i>
                        </div>
                    </div>
                    <div class="ml-4 flex-1">
                        <div class="flex items-center justify-between">
                            <h3 class="text-sm font-medium text-gray-900 {% if not notification.is_read %}font-semibold{% endif %}">
                                {{ notification.title }}
                            </h3>
                            <span class="text-xs text-gray-500">
                                {{ notification.created_at.strftime('%m/%d %H:%M') }}
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mt-1">{{ notification.content }}</p>
                        {% if not notification.is_read %}
                            <button onclick="markNotificationRead({{ notification.id }})" class="mt-2 text-xs text-primary hover:text-blue-700">
                                Mark as read
                            </button>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-8">
                <i class="fas fa-bell-slash text-gray-400 text-4xl mb-4"></i>
                <p class="text-gray-500">No notifications yet</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Recent Assignments -->
<div class="bg-white rounded-xl shadow-lg">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900 flex items-center">
            <i class="fas fa-clock mr-2 text-info"></i>Recent Assignments
        </h2>
    </div>
    <div class="p-6">
        {% if recent_assignments %}
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Title</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Subject</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Teacher</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Due Date</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        {% for assignment in recent_assignments %}
                        <tr class="hover:bg-gray-50">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{{ assignment.title }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ assignment.subject.name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ assignment.teacher.first_name }} {{ assignment.teacher.last_name }}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ assignment.due_date.strftime('%Y-%m-%d') }}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                {% if assignment.due_date < date.today() %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Overdue</span>
                                {% elif assignment.due_date == date.today() %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Due Today</span>
                                {% else %}
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        {% else %}
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-inbox text-2xl text-gray-400"></i>
                </div>
                <p class="text-gray-500">No recent assignments found.</p>
            </div>
        {% endif %}
    </div>
</div>{% endblock %}

<script>
// Auto-refresh dashboard data every 30 seconds
function refreshDashboardData() {
    fetch('/api/admin/dashboard-data')
        .then(response => response.json())
        .then(data => {
            // Update teacher submissions table
            updateTeacherSubmissionsTable(data.teachers_with_submissions);
            
            // Update recent assignments table
            updateRecentAssignments(data.recent_assignments);
            
            // Show last updated time
            updateLastRefreshTime();
        })
        .catch(error => console.error('Error refreshing dashboard data:', error));
}

function updateTeacherSubmissionsTable(teachersData) {
    const tbody = document.querySelector('#teacher-submissions-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    teachersData.forEach(teacherData => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex items-center">
                    <div class="w-10 h-10 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user text-primary"></i>
                    </div>
                    <div>
                        <div class="text-sm font-medium text-gray-900">${teacherData.teacher.first_name} ${teacherData.teacher.last_name}</div>
                        <div class="text-sm text-gray-500">${teacherData.teacher.email}</div>
    </div>
</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${teacherData.teacher.classes.length > 0 ? 
                    teacherData.teacher.classes.map(cls => cls.name).join('<br>') : 
                    '<span class="text-gray-400">No classes assigned</span>'
                }
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-teal-100 text-teal-800">
                    ${teacherData.homework_count} records
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                    ${teacherData.lesson_count} lessons
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">
                    ${teacherData.total_submissions} total
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                ${teacherData.total_submissions > 0 ? 
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800"><i class="fas fa-check-circle mr-1"></i>Active</span>' :
                    '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800"><i class="fas fa-exclamation-triangle mr-1"></i>No Submissions</span>'
                }
            </td>
        `;
        tbody.appendChild(row);
    });
}

function updateRecentAssignments(assignments) {
    const tbody = document.querySelector('#recent-assignments-table tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    assignments.forEach(assignment => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${assignment.title}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignment.subject.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignment.teacher.first_name} ${assignment.teacher.last_name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignment.due_date}</td>
            <td class="px-6 py-4 whitespace-nowrap">
                ${getAssignmentStatusBadge(assignment.due_date)}
            </td>
        `;
        tbody.appendChild(row);
    });
}

function getAssignmentStatusBadge(dueDate) {
    const today = new Date();
    const due = new Date(dueDate);
    
    if (due < today) {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Overdue</span>';
    } else if (due.toDateString() === today.toDateString()) {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Due Today</span>';
    } else {
        return '<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>';
    }
}

function updateLastRefreshTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    
    // Create or update refresh indicator
    let refreshIndicator = document.getElementById('refresh-indicator');
    if (!refreshIndicator) {
        refreshIndicator = document.createElement('div');
        refreshIndicator.id = 'refresh-indicator';
        refreshIndicator.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-3 py-2 rounded-lg text-sm shadow-lg z-50';
        document.body.appendChild(refreshIndicator);
    }
    
    refreshIndicator.innerHTML = `
        <i class="fas fa-sync-alt mr-2"></i>Last updated: ${timeString}
    `;
    
    // Hide after 3 seconds
    setTimeout(() => {
        if (refreshIndicator.parentNode) {
            refreshIndicator.remove();
        }
    }, 3000);
}

// Start auto-refresh
setInterval(refreshDashboardData, 30000); // Refresh every 30 seconds

// Initial load when page is ready
document.addEventListener('DOMContentLoaded', function() {
    // Add IDs to tables for easier targeting
    const teacherTable = document.querySelector('table tbody');
    if (teacherTable && teacherTable.closest('table').querySelector('th').textContent.includes('Teacher')) {
        teacherTable.closest('table').id = 'teacher-submissions-table';
    }
    
    const assignmentTable = document.querySelector('table');
    if (assignmentTable && assignmentTable.querySelector('th') && assignmentTable.querySelector('th').textContent.includes('Title')) {
        assignmentTable.id = 'recent-assignments-table';
    }
    
    // Start refreshing
    refreshDashboardData();
});

// Notification functions
function markNotificationRead(notificationId) {
    fetch(`/admin/notification/${notificationId}/read`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the "Mark as read" button and update styling
            const notificationElement = document.querySelector(`button[onclick="markNotificationRead(${notificationId})"]`).closest('.flex.items-start');
            if (notificationElement) {
                notificationElement.classList.remove('bg-blue-50', 'border-blue-200');
                notificationElement.classList.add('bg-gray-50');
                
                // Remove the mark as read button
                const markAsReadButton = notificationElement.querySelector('button[onclick*="markNotificationRead"]');
                if (markAsReadButton) {
                    markAsReadButton.remove();
                }
                
                // Update font weight
                const titleElement = notificationElement.querySelector('h3');
                if (titleElement) {
                    titleElement.classList.remove('font-semibold');
                }
            }
            
            // Update unread count
            const unreadBadge = document.querySelector('.bg-red-100.text-red-800');
            if (unreadBadge) {
                const currentCount = parseInt(unreadBadge.textContent);
                if (currentCount > 1) {
                    unreadBadge.textContent = `${currentCount - 1} unread`;
                } else {
                    unreadBadge.remove();
                }
            }
            
            // Update navigation notification count
            if (typeof loadNotificationCount === 'function') {
                loadNotificationCount();
            }
        }
    })
    .catch(error => {
        console.error('Error marking notification as read:', error);
    });
}

