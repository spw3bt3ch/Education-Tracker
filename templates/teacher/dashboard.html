{% extends "base.html" %}

{% block title %}Teacher Dashboard - SMIED{% endblock %}

{% block content %}
<!-- Welcome Section with Profile Picture -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6 sm:mb-8">
    <div class="flex flex-col sm:flex-row items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-6">
        <!-- Profile Picture -->
        <div class="flex-shrink-0">
            {% if current_user.profile_picture %}
                <img src="{{ url_for('static', filename=current_user.profile_picture) }}" 
                     alt="Profile Picture" 
                     class="w-20 h-20 rounded-full object-cover border-4 border-success shadow-lg">
            {% else %}
                <div class="w-20 h-20 bg-success bg-opacity-10 rounded-full flex items-center justify-center border-4 border-success shadow-lg">
                    <i class="fas fa-chalkboard-teacher text-3xl text-success"></i>
                </div>
            {% endif %}
        </div>
        
        <!-- Welcome Text and Info -->
        <div class="flex-1 min-w-0">
            <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 mb-2">
                Welcome back, {{ current_user.first_name }}!
            </h1>
            <p class="text-gray-600 mb-3">Ready to inspire and educate your students today?</p>
            
            <!-- School Information - Prominently Displayed -->
            {% if current_user.school %}
            <div class="bg-gradient-to-r from-success to-green-600 rounded-lg p-4 mb-4 text-white">
                <div class="flex items-center justify-between">
                    <div>
                        <h2 class="text-xl font-bold mb-1">
                            <i class="fas fa-school mr-2"></i>
                            {{ current_user.school.name }}
                        </h2>
                        {% if current_user.school.contact_email %}
                        <p class="text-green-100 text-sm">
                            <i class="fas fa-envelope mr-1"></i>
                            {{ current_user.school.contact_email }}
                        </p>
                        {% endif %}
                        {% if current_user.school.address %}
                        <p class="text-green-100 text-sm">
                            <i class="fas fa-map-marker-alt mr-1"></i>
                            {{ current_user.school.address }}
                        </p>
                        {% endif %}
                    </div>
                    <div class="text-right">
                        <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-white bg-opacity-20 text-white">
                            <i class="fas fa-chalkboard-teacher mr-1"></i>
                            Class Teacher
                        </span>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="flex flex-wrap items-center gap-3">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-success text-white">
                    <i class="fas fa-chalkboard-teacher mr-1"></i>
                    Class Teacher
                </span>
                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-gray-100 text-gray-700">
                    <i class="fas fa-school mr-1"></i>
                    Teacher
                </span>
            </div>
            {% endif %}
        </div>
        
        <!-- Quick Stats -->
        <div class="flex-shrink-0 hidden sm:block">
            <div class="text-right">
                <div class="text-2xl font-bold text-success">{{ my_classes|length }}</div>
                <div class="text-sm text-gray-500">Classes</div>
            </div>
        </div>
    </div>
</div>

<!-- Notifications Section -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-6">
    <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold text-gray-900 flex items-center">
            <i class="fas fa-bell mr-2 text-warning"></i>
            Notifications
        </h3>
        <a href="{{ url_for('teacher_messages') }}" class="text-sm text-info hover:text-cyan-600 relative">
            View All Messages
            {% if unread_messages > 0 %}
            <span class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center font-bold">
                {{ unread_messages }}
            </span>
            {% endif %}
        </a>
    </div>
    
    <div id="notifications-container">
        <!-- Notifications will be loaded here via JavaScript -->
        <div class="text-center py-4">
            <i class="fas fa-spinner fa-spin text-gray-400"></i>
            <p class="text-gray-500 mt-2">Loading notifications...</p>
        </div>
    </div>
</div>

<!-- My Classes -->
<div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6 sm:mb-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 space-y-2 sm:space-y-0">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-900 flex items-center">
            <i class="fas fa-school mr-2 text-primary"></i>My Classes
        </h2>
        <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2">
            <a href="{{ url_for('register_parent') }}" class="bg-success text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 text-sm text-center">
                <i class="fas fa-user-plus mr-1"></i>Register Parent
            </a>
            <span class="text-xs sm:text-sm text-gray-500 self-center">Classes assigned by Head Teacher</span>
        </div>
    </div>
    
    {% if classes %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for class in classes %}
            <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow duration-200">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900">{{ class.name }}</h3>
                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">
                        Basic {{ class.grade_level }}
                    </span>
                </div>
                <div class="space-y-2 text-sm text-gray-600 mb-4">
                    <div class="flex items-center">
                        <i class="fas fa-graduation-cap mr-2"></i>
                        {{ class.students|length }} students
                    </div>
                    <div class="flex items-center">
                        <i class="fas fa-book mr-2"></i>
                        {{ class.subjects|length }} subjects
                    </div>
                </div>
                <div class="flex space-x-2">
                    <a href="{{ url_for('view_class', class_id=class.id) }}" class="flex-1 bg-primary text-white px-3 py-2 rounded text-sm hover:bg-blue-700 transition duration-200 text-center">
                        <i class="fas fa-eye mr-1"></i>View
                    </a>
                    <a href="{{ url_for('manage_students', class_id=class.id) }}" class="flex-1 bg-success text-white px-3 py-2 rounded text-sm hover:bg-green-700 transition duration-200 text-center">
                        <i class="fas fa-users mr-1"></i>Students
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="text-center py-12">
            <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-school text-2xl text-gray-400"></i>
            </div>
            <p class="text-gray-500 mb-4">No classes assigned yet.</p>
            <a href="{{ url_for('create_class') }}" class="bg-primary text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition duration-200">
                <i class="fas fa-plus mr-2"></i>Create Your First Class
            </a>
        </div>
    {% endif %}
</div>

<!-- Quick Actions -->
<div class="bg-white rounded-xl shadow-lg p-6 mb-8">
    <h2 class="text-xl font-semibold text-gray-900 mb-6 flex items-center">
        <i class="fas fa-tools mr-2 text-primary"></i>Quick Actions
    </h2>
    
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
        <a href="{{ url_for('manage_students') }}" class="bg-primary text-white p-4 rounded-lg hover:bg-blue-700 transition duration-200 text-center">
            <i class="fas fa-graduation-cap text-2xl mb-2"></i>
            <div class="text-sm font-medium">Manage Students</div>
        </a>
        
        <a href="{{ url_for('manage_subjects') }}" class="bg-success text-white p-4 rounded-lg hover:bg-green-700 transition duration-200 text-center">
            <i class="fas fa-book text-2xl mb-2"></i>
            <div class="text-sm font-medium">Manage Subjects</div>
        </a>
        
        <a href="{{ url_for('manage_assignments') }}" class="bg-warning text-white p-4 rounded-lg hover:bg-yellow-700 transition duration-200 text-center">
            <i class="fas fa-tasks text-2xl mb-2"></i>
            <div class="text-sm font-medium">Manage Assignments</div>
        </a>
        
        <a href="{{ url_for('register_parent') }}" class="bg-info text-white p-4 rounded-lg hover:bg-cyan-700 transition duration-200 text-center">
            <i class="fas fa-user-plus text-2xl mb-2"></i>
            <div class="text-sm font-medium">Register Parent</div>
        </a>
        
        <a href="{{ url_for('teacher_report_cards') }}" class="bg-purple-500 text-white p-4 rounded-lg hover:bg-purple-600 transition duration-200 text-center">
            <i class="fas fa-file-alt text-2xl mb-2"></i>
            <div class="text-sm font-medium">Report Cards</div>
        </a>
        
        <a href="{{ url_for('teacher_attendance') }}" class="bg-orange-500 text-white p-4 rounded-lg hover:bg-orange-600 transition duration-200 text-center">
            <i class="fas fa-calendar-check text-2xl mb-2"></i>
            <div class="text-sm font-medium">Attendance</div>
        </a>
        
        <a href="{{ url_for('create_lesson') }}" class="bg-indigo-500 text-white p-4 rounded-lg hover:bg-indigo-600 transition duration-200 text-center">
            <i class="fas fa-chalkboard text-2xl mb-2"></i>
            <div class="text-sm font-medium">Create Lesson</div>
        </a>
        
        <a href="{{ url_for('teacher_lessons') }}" class="bg-teal-500 text-white p-4 rounded-lg hover:bg-teal-600 transition duration-200 text-center">
            <i class="fas fa-list text-2xl mb-2"></i>
            <div class="text-sm font-medium">Manage Lessons</div>
        </a>
        
        <a href="{{ url_for('teacher_homework_records') }}" class="bg-purple-500 text-white p-4 rounded-lg hover:bg-purple-600 transition duration-200 text-center">
            <i class="fas fa-book-open text-2xl mb-2"></i>
            <div class="text-sm font-medium">Homework Records</div>
        </a>
        
        <a href="{{ url_for('teacher_messages') }}" class="bg-orange-500 text-white p-4 rounded-lg hover:bg-orange-600 transition duration-200 text-center relative">
            <i class="fas fa-envelope text-2xl mb-2"></i>
            <div class="text-sm font-medium">Messages</div>
            <span id="messageBadge" class="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-6 w-6 flex items-center justify-center hidden">0</span>
        </a>
    </div>
</div>

<!-- Parent Management -->
<div class="bg-white rounded-xl shadow-lg p-4 sm:p-6 mb-6 sm:mb-8">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 sm:mb-6 space-y-2 sm:space-y-0">
        <h2 class="text-lg sm:text-xl font-semibold text-gray-900 flex items-center">
            <i class="fas fa-users mr-2 text-info"></i>Registered Parents
        </h2>
        <div class="text-xs sm:text-sm text-gray-500">
            Parents from your classes
        </div>
    </div>
    
    {% if parents %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parent Name</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Username</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Password</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Students</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for parent in parents %}
                    <tr class="hover:bg-gray-50" data-parent-id="{{ parent.id }}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <div class="flex-shrink-0 h-10 w-10">
                                    {% if parent.profile_picture %}
                                        <img class="h-10 w-10 rounded-full object-cover" src="{{ url_for('static', filename=parent.profile_picture) }}" alt="Profile">
                                    {% else %}
                                        <div class="h-10 w-10 rounded-full bg-info bg-opacity-10 flex items-center justify-center">
                                            <i class="fas fa-user text-info"></i>
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="ml-4">
                                    <div class="text-sm font-medium text-gray-900">
                                        {{ parent.first_name }} {{ parent.last_name }}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        ID: {{ parent.id }}
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="fas fa-user mr-2 text-gray-400"></i>
                                <span class="font-mono text-sm">{{ parent.username }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="flex items-center">
                                <i class="fas fa-envelope mr-2 text-gray-400"></i>
                                {{ parent.email }}
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            <div class="flex items-center">
                                <i class="fas fa-key mr-2 text-gray-400"></i>
                                <span class="font-mono text-sm" id="password-{{ parent.id }}">••••••••</span>
                                <button onclick="togglePassword({{ parent.id }})" 
                                        class="ml-2 text-blue-600 hover:text-blue-800 text-xs">
                                    <i class="fas fa-eye" id="eye-{{ parent.id }}"></i>
                                </button>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                            {% set parent_students = [] %}
                            {% for class in classes %}
                                {% for student in class.students %}
                                    {% if student.parent_id == parent.id %}
                                        {% set _ = parent_students.append(student) %}
                                    {% endif %}
                                {% endfor %}
                            {% endfor %}
                            <div class="flex items-center">
                                <i class="fas fa-child mr-2 text-gray-400"></i>
                                <span class="text-sm">{{ parent_students|length }} student(s)</span>
                            </div>
                            {% if parent_students %}
                            <div class="text-xs text-gray-500 mt-1">
                                {% for student in parent_students[:2] %}
                                    {{ student.first_name }} {{ student.last_name }}{% if not loop.last %}, {% endif %}
                                {% endfor %}
                                {% if parent_students|length > 2 %}
                                    +{{ parent_students|length - 2 }} more
                                {% endif %}
                            </div>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                            <div class="flex space-x-2">
                                <button onclick="viewParent({{ parent.id }})" 
                                        class="text-blue-600 hover:text-blue-700 transition duration-150 ease-in-out"
                                        title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button onclick="resetParentPassword({{ parent.id }})" 
                                        class="text-purple-600 hover:text-purple-700 transition duration-150 ease-in-out"
                                        title="Reset Password">
                                    <i class="fas fa-key"></i>
                                </button>
                                <button onclick="deleteParent({{ parent.id }})" 
                                        class="text-red-600 hover:text-red-700 transition duration-150 ease-in-out"
                                        title="Delete Parent">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <div class="text-center py-8">
            <div class="mx-auto h-12 w-12 text-gray-400">
                <i class="fas fa-users text-4xl"></i>
            </div>
            <h3 class="mt-2 text-sm font-medium text-gray-900">No parents registered</h3>
            <p class="mt-1 text-sm text-gray-500">Parents will appear here once they register for your classes.</p>
            <div class="mt-6">
                <a href="{{ url_for('register_parent') }}" class="inline-flex items-center px-4 py-2 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-info hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-info">
                    <i class="fas fa-user-plus mr-2"></i>
                    Register Parent
                </a>
            </div>
        </div>
    {% endif %}
</div>

<!-- Parent View Modal -->
<div id="parentViewModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full hidden z-50">
    <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-md bg-white">
        <div class="mt-3">
            <!-- Modal Header -->
            <div class="flex items-center justify-between pb-4 border-b">
                <h3 class="text-lg font-medium text-gray-900" id="modalTitle">
                    Parent Details
                </h3>
                <button onclick="closeParentModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- Modal Content -->
            <div class="mt-4" id="parentModalContent">
                <div class="text-center py-8">
                    <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
                    <p class="text-gray-500 mt-2">Loading parent details...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Assignments -->
<div class="bg-white rounded-xl shadow-lg">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-tasks mr-2 text-success"></i>Recent Assignments
            </h2>
            <a href="{{ url_for('create_assignment') }}" class="bg-success text-white px-4 py-2 rounded-lg hover:bg-green-700 transition duration-200 text-sm">
                <i class="fas fa-plus mr-1"></i>New Assignment
            </a>
        </div>
    </div>
    <div class="p-6">
        {% if recent_assignments %}
            <div class="space-y-4">
                {% for assignment in recent_assignments %}
                <div class="border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow duration-200">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900">{{ assignment.title }}</h3>
                            <p class="text-sm text-gray-600 mt-1">{{ assignment.description[:100] if assignment.description else 'No description' }}{% if assignment.description and assignment.description|length > 100 %}...{% endif %}</p>
                        </div>
                        <div class="flex space-x-2">
                            <a href="{{ url_for('view_assignment', assignment_id=assignment.id) }}" class="text-primary hover:text-blue-700 p-2">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="{{ url_for('edit_assignment', assignment_id=assignment.id) }}" class="text-warning hover:text-yellow-700 p-2">
                                <i class="fas fa-edit"></i>
                            </a>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-sm">
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-book mr-2"></i>
                            {{ assignment.subject.name }}
                        </div>
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-school mr-2"></i>
                            {{ assignment.subject.class_obj.name }}
                        </div>
                        <div class="flex items-center text-gray-600">
                            <i class="fas fa-calendar mr-2"></i>
                            Due: {{ assignment.due_date.strftime('%Y-%m-%d') }}
                        </div>
                        <div class="flex items-center">
                            {% set completed = assignment.assignment_records|selectattr('completed', 'equalto', true)|list|length %}
                            {% set total = assignment.assignment_records|length %}
                            {% if total > 0 %}
                                <div class="flex-1 bg-gray-200 rounded-full h-2 mr-2">
                                    <div class="bg-success h-2 rounded-full" style="width: {{ (completed/total*100)|round(1) }}%"></div>
                                </div>
                                <span class="text-sm text-gray-600">{{ completed }}/{{ total }}</span>
                            {% else %}
                                <span class="text-sm text-gray-500">No students assigned</span>
                            {% endif %}
                        </div>
                    </div>
                    
                    <div class="mt-4 flex justify-between items-center">
                        <div class="flex space-x-2">
                            {% if assignment.due_date < date.today() %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800">Overdue</span>
                            {% elif assignment.due_date == date.today() %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">Due Today</span>
                            {% else %}
                                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">Active</span>
                            {% endif %}
                        </div>
                        <a href="{{ url_for('view_assignment', assignment_id=assignment.id) }}" class="text-primary hover:text-blue-700 text-sm font-medium">
                            View Details <i class="fas fa-arrow-right ml-1"></i>
                        </a>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-12">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-tasks text-2xl text-gray-400"></i>
                </div>
                <p class="text-gray-500 mb-4">No assignments created yet.</p>
                <a href="{{ url_for('create_assignment') }}" class="bg-success text-white px-6 py-3 rounded-lg hover:bg-green-700 transition duration-200">
                    <i class="fas fa-plus mr-2"></i>Create Your First Assignment
                </a>
            </div>
        {% endif %}
    </div>
</div>

<!-- Lesson Planning Section -->
<div class="bg-white rounded-xl shadow-lg mt-8">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-chalkboard mr-2 text-indigo-500"></i>Lesson Planning
            </h2>
            <div class="flex space-x-2">
                <a href="{{ url_for('teacher_lessons') }}" class="bg-indigo-500 text-white px-4 py-2 rounded-lg hover:bg-indigo-600 transition duration-200 text-sm">
                    <i class="fas fa-list mr-1"></i>All Lessons
                </a>
                <a href="{{ url_for('create_lesson') }}" class="bg-teal-500 text-white px-4 py-2 rounded-lg hover:bg-teal-600 transition duration-200 text-sm">
                    <i class="fas fa-plus mr-1"></i>Create Lesson
                </a>
                <button onclick="openSMIEDAssistant()" class="bg-gradient-to-r from-purple-500 to-indigo-600 hover:from-purple-600 hover:to-indigo-700 text-white px-4 py-2 rounded-lg transition-all duration-200 text-sm shadow-lg hover:shadow-xl transform hover:scale-105" title="SMIED AI Assistant">
                    <i class="fas fa-robot mr-1"></i>SMIED Assistant
                </button>
            </div>
        </div>
    </div>
    <div class="p-6">
        <div class="text-center py-8">
            <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-chalkboard text-2xl text-indigo-500"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Unified Lesson Planning</h3>
            <p class="text-gray-500 mb-4">Create comprehensive lesson plans and take notes in one integrated system following Nigerian education standards</p>
            <div class="flex flex-col sm:flex-row gap-3 justify-center">
                <a href="{{ url_for('create_lesson') }}" class="bg-indigo-500 text-white px-6 py-3 rounded-lg hover:bg-indigo-600 transition duration-200">
                    <i class="fas fa-plus mr-2"></i>Create New Lesson
                </a>
                <a href="{{ url_for('teacher_lessons') }}" class="bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 transition duration-200">
                    <i class="fas fa-list mr-2"></i>View All Lessons
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Homework Records Section -->
<div class="bg-white rounded-xl shadow-lg mt-8">
    <div class="px-6 py-4 border-b border-gray-200">
        <div class="flex justify-between items-center">
            <h2 class="text-xl font-semibold text-gray-900 flex items-center">
                <i class="fas fa-book-open mr-2 text-purple-500"></i>Homework Records
            </h2>
            <a href="{{ url_for('teacher_homework_records') }}" class="bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition duration-200 text-sm">
                <i class="fas fa-plus mr-1"></i>Manage Records
            </a>
        </div>
    </div>
    <div class="p-6">
        <div class="text-center py-8">
            <div class="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-book-open text-2xl text-purple-500"></i>
            </div>
            <h3 class="text-lg font-medium text-gray-900 mb-2">Track Weekly Homework</h3>
            <p class="text-gray-500 mb-4">Submit weekly homework records for head teacher review</p>
            <a href="{{ url_for('create_homework_record') }}" class="bg-purple-500 text-white px-6 py-3 rounded-lg hover:bg-purple-600 transition duration-200">
                <i class="fas fa-plus mr-2"></i>Create Homework Record
            </a>
        </div>
    </div>
</div>

<!-- Admin Comments Section -->
{% if recent_comments %}
<div class="bg-white rounded-xl shadow-lg mt-8">
    <div class="px-6 py-4 border-b border-gray-200">
        <h2 class="text-xl font-semibold text-gray-900 flex items-center">
            <i class="fas fa-comments mr-2 text-primary"></i>Recent Admin Comments
        </h2>
    </div>
    <div class="p-6">
        <div class="space-y-4">
            {% for comment in recent_comments %}
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow duration-200">
                <div class="flex justify-between items-start mb-3">
                    <div class="flex items-center">
                        <div class="w-8 h-8 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mr-3">
                            <i class="fas fa-user text-primary text-sm"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-medium text-gray-900">{{ comment.admin.first_name }} {{ comment.admin.last_name }}</h4>
                            <p class="text-xs text-gray-500">{{ comment.created_at.strftime('%Y-%m-%d %H:%M') }}</p>
                        </div>
                    </div>
                    <a href="{{ url_for('view_lesson', lesson_id=comment.lesson.id) }}" class="text-primary hover:text-blue-700 text-sm">
                        <i class="fas fa-eye mr-1"></i>View Lesson
                    </a>
                </div>
                
                <div class="mb-2">
                    <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                        {{ comment.lesson.title }}
                    </span>
                </div>
                
                <p class="text-gray-700 whitespace-pre-wrap">{{ comment.comment }}</p>
            </div>
            {% endfor %}
        </div>
        
        <div class="mt-4 text-center">
            <a href="{{ url_for('teacher_lessons') }}" class="text-primary hover:text-blue-700 text-sm font-medium">
                <i class="fas fa-list mr-1"></i>View All Lessons with Comments
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- Notification Sound -->
<audio id="notificationSound" preload="auto">
    <source src="{{ url_for('static', filename='sounds/notification.mp3') }}" type="audio/mpeg">
    <source src="{{ url_for('static', filename='sounds/notification.wav') }}" type="audio/wav">
</audio>

<script>
// Check for new messages and comments every 30 seconds
function checkNotifications() {
    fetch('/api/teacher/notifications')
        .then(response => response.json())
        .then(data => {
            const messageBadge = document.getElementById('messageBadge');
            
            if (data.unread_messages > 0) {
                messageBadge.textContent = data.unread_messages;
                messageBadge.classList.remove('hidden');
                
                // Play notification sound
                const audio = document.getElementById('notificationSound');
                audio.play().catch(e => console.log('Could not play notification sound:', e));
                
                // Show browser notification if permission granted
                if (Notification.permission === 'granted') {
                    new Notification('New Message Received', {
                        body: 'You have received a new message from the head teacher.',
                        icon: '/static/images/notification-icon.png'
                    });
                }
            } else {
                messageBadge.classList.add('hidden');
            }
            
            // Show recent homework comments if any
            if (data.recent_comments && data.recent_comments.length > 0) {
                showCommentNotifications(data.recent_comments);
            }
        })
        .catch(error => console.error('Error checking notifications:', error));
}

function showCommentNotifications(comments) {
    // Show toast notifications for new comments
    comments.forEach(comment => {
        if (isNewComment(comment)) {
            showToast(`New comment on ${comment.week} homework record`, comment.comment);
        }
    });
}

function isNewComment(comment) {
    // Check if comment is from the last 5 minutes
    const commentTime = new Date(comment.created_at);
    const now = new Date();
    const diffMinutes = (now - commentTime) / (1000 * 60);
    return diffMinutes <= 5;
}

function showToast(title, message) {
    // Create toast notification
    const toast = document.createElement('div');
    toast.className = 'fixed top-4 right-4 bg-blue-500 text-white p-4 rounded-lg shadow-lg z-50 max-w-sm';
    toast.innerHTML = `
        <div class="flex justify-between items-start">
            <div>
                <h4 class="font-semibold">${title}</h4>
                <p class="text-sm mt-1">${message.substring(0, 100)}${message.length > 100 ? '...' : ''}</p>
            </div>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-2 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

// Check notifications on page load
document.addEventListener('DOMContentLoaded', function() {
    checkNotifications();
    
    // Check every 30 seconds
    setInterval(checkNotifications, 30000);
    
    // Request notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
});

// Real-time updates for teacher dashboard
function refreshTeacherDashboardData() {
    fetch('/api/teacher/dashboard-data')
        .then(response => response.json())
        .then(data => {
            // Update classes section
            updateClassesSection(data.classes);
            
            // Update recent assignments
            updateRecentAssignments(data.recent_assignments);
            
            // Update recent comments
            updateRecentComments(data.recent_comments);
            
            // Show last updated time
            updateLastRefreshTime();
        })
        .catch(error => console.error('Error refreshing teacher dashboard data:', error));
}

function updateClassesSection(classesData) {
    const classesContainer = document.querySelector('.grid.grid-cols-1.md\:grid-cols-2.lg\:grid-cols-3.gap-6');
    if (!classesContainer) return;
    
    classesContainer.innerHTML = '';
    
    classesData.forEach(classData => {
        const classCard = document.createElement('div');
        classCard.className = 'border border-gray-200 rounded-lg p-6 hover:shadow-md transition-shadow duration-200';
        classCard.innerHTML = `
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">${classData.name}</h3>
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-primary text-white">
                    Basic ${classData.grade_level}
                </span>
            </div>
            <div class="space-y-2 text-sm text-gray-600 mb-4">
                <div class="flex items-center">
                    <i class="fas fa-graduation-cap mr-2"></i>
                    ${classData.student_count} students
                </div>
                <div class="flex items-center">
                    <i class="fas fa-book mr-2"></i>
                    ${classData.subject_count} subjects
                </div>
            </div>
            <div class="flex space-x-2">
                <a href="/teacher/class/${classData.id}" class="flex-1 bg-primary text-white px-3 py-2 rounded text-sm hover:bg-blue-700 transition duration-200 text-center">
                    <i class="fas fa-eye mr-1"></i>View Details
                </a>
            </div>
        `;
        classesContainer.appendChild(classCard);
    });
}

function updateRecentAssignments(assignmentsData) {
    const assignmentsContainer = document.querySelector('#recent-assignments-table tbody');
    if (!assignmentsContainer) return;
    
    assignmentsContainer.innerHTML = '';
    
    assignmentsData.forEach(assignment => {
        const row = document.createElement('tr');
        row.className = 'hover:bg-gray-50';
        row.innerHTML = `
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${assignment.title}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignment.subject.name}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignment.due_date}</td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${assignment.created_at}</td>
        `;
        assignmentsContainer.appendChild(row);
    });
}

function updateRecentComments(commentsData) {
    const commentsContainer = document.querySelector('#recent-comments-container');
    if (!commentsContainer) return;
    
    if (commentsData.length === 0) {
        commentsContainer.innerHTML = `
            <div class="text-center py-8">
                <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-comments text-2xl text-gray-400"></i>
                </div>
                <p class="text-gray-500">No admin comments yet</p>
                <p class="text-gray-400 text-sm mt-1">Comments from administrators will appear here</p>
            </div>
        `;
        return;
    }
    
    commentsContainer.innerHTML = '';
    
    commentsData.forEach(comment => {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'border border-gray-200 rounded-lg p-4 hover:shadow-sm transition-shadow duration-200';
        commentDiv.innerHTML = `
            <div class="flex justify-between items-start mb-3">
                <div class="flex items-center">
                    <div class="w-8 h-8 bg-primary bg-opacity-10 rounded-full flex items-center justify-center mr-3">
                        <i class="fas fa-user text-primary text-sm"></i>
                    </div>
                    <div>
                                        <h4 class="text-sm font-medium text-gray-900">${comment.admin.first_name} ${comment.admin.last_name}</h4>
                        <p class="text-xs text-gray-500">${comment.created_at}</p>
                    </div>
                </div>
                <a href="/teacher/lesson/${comment.lesson.id}" class="text-primary hover:text-blue-700 text-sm">
                    <i class="fas fa-eye mr-1"></i>View Lesson
                </a>
            </div>
            <div class="mb-2">
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 text-indigo-800">
                    ${comment.lesson.title}
                </span>
            </div>
            <p class="text-gray-700 whitespace-pre-wrap">${comment.comment}</p>
        `;
        commentsContainer.appendChild(commentDiv);
    });
}

function updateLastRefreshTime() {
    const now = new Date();
    const timeString = now.toLocaleTimeString();
    
    // Create or update refresh indicator
    let refreshIndicator = document.getElementById('refresh-indicator');
    if (!refreshIndicator) {
        refreshIndicator = document.createElement('div');
        refreshIndicator.id = 'refresh-indicator';
        refreshIndicator.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-3 py-2 rounded-lg text-sm shadow-lg z-50';
        document.body.appendChild(refreshIndicator);
    }
    
    refreshIndicator.innerHTML = `
        <i class="fas fa-sync-alt mr-2"></i>Last updated: ${timeString}
    `;
    
    // Hide after 3 seconds
    setTimeout(() => {
        if (refreshIndicator.parentNode) {
            refreshIndicator.remove();
        }
    }, 3000);
}

// Start auto-refresh for teacher dashboard
setInterval(refreshTeacherDashboardData, 30000); // Refresh every 30 seconds

// Initial load when page is ready
document.addEventListener('DOMContentLoaded', function() {
    // Add IDs to elements for easier targeting
    const assignmentsTable = document.querySelector('table tbody');
    if (assignmentsTable) {
        assignmentsTable.closest('table').id = 'recent-assignments-table';
    }
    
    const commentsContainer = document.querySelector('.space-y-4');
    if (commentsContainer) {
        commentsContainer.id = 'recent-comments-container';
    }
    
    // Start refreshing
    refreshTeacherDashboardData();
    
    // Load notifications
    loadNotifications();
});

// Load notifications function
async function loadNotifications() {
    try {
        const response = await fetch('/api/teacher/notifications');
        const data = await response.json();
        
        const container = document.getElementById('notifications-container');
        
        if (data.notifications && data.notifications.length > 0) {
            container.innerHTML = data.notifications.map(notification => `
                <div class="border border-gray-200 rounded-lg p-4 mb-3 hover:bg-gray-50 transition duration-200">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-medium text-gray-900">${notification.title}</h4>
                            <p class="text-sm text-gray-600 mt-1">${notification.content}</p>
                            <p class="text-xs text-gray-500 mt-2">${new Date(notification.created_at).toLocaleString()}</p>
                        </div>
                        <div class="ml-4">
                            ${notification.is_read ? 
                                '<span class="text-xs text-gray-400">Read</span>' : 
                                '<span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-warning text-white">New</span>'
                            }
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-bell-slash text-3xl text-gray-400 mb-3"></i>
                    <p class="text-gray-500">No notifications yet</p>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error loading notifications:', error);
        document.getElementById('notifications-container').innerHTML = `
            <div class="text-center py-4">
                <p class="text-red-500">Error loading notifications</p>
            </div>
        `;
    }
}

// Refresh notifications every 10 seconds
setInterval(loadNotifications, 10000);

// Parent Password Management Functions
function togglePassword(parentId) {
    const passwordElement = document.getElementById(`password-${parentId}`);
    const eyeElement = document.getElementById(`eye-${parentId}`);
    
    if (passwordElement.textContent === '••••••••') {
        // Show password placeholder
        passwordElement.textContent = 'Hidden for security';
        eyeElement.className = 'fas fa-eye-slash';
        showNotification('Password is hidden for security. Use reset button to generate new password.', 'info');
    } else {
        // Hide password
        passwordElement.textContent = '••••••••';
        eyeElement.className = 'fas fa-eye';
    }
}

function resetParentPassword(parentId) {
    if (confirm('Are you sure you want to reset the password for this parent? This action cannot be undone.')) {
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        fetch(`/api/teacher/parent/${parentId}/reset-password`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(`Password reset successfully! New password: ${data.new_password}`, 'success');
                const passwordElement = document.getElementById(`password-${parentId}`);
                if (passwordElement) {
                    passwordElement.textContent = data.new_password;
                    const eyeElement = document.getElementById(`eye-${parentId}`);
                    if (eyeElement) {
                        eyeElement.className = 'fas fa-eye-slash';
                    }
                }
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error resetting password:', error);
            showNotification('Error resetting password: ' + error.message, 'error');
        })
        .finally(() => {
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }
}

function viewParent(parentId) {
    const modal = document.getElementById('parentViewModal');
    const modalContent = document.getElementById('parentModalContent');
    const modalTitle = document.getElementById('modalTitle');
    
    // Show modal with loading state
    modal.classList.remove('hidden');
    modalContent.innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-spinner fa-spin text-2xl text-gray-400"></i>
            <p class="text-gray-500 mt-2">Loading parent details...</p>
        </div>
    `;
    
    // Fetch parent details
    fetch(`/api/teacher/parent/${parentId}/view`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const parent = data.parent;
                const students = data.students;
                
                modalTitle.textContent = `${parent.first_name} ${parent.last_name} - Details`;
                modalContent.innerHTML = `
                    <div class="space-y-6">
                        <!-- Parent Information -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-user mr-2 text-blue-600"></i>
                                Parent Information
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-sm font-medium text-gray-500">Full Name</label>
                                    <p class="text-gray-900">${parent.first_name} ${parent.last_name}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-500">Username</label>
                                    <p class="text-gray-900 font-mono">${parent.username}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-500">Email</label>
                                    <p class="text-gray-900">${parent.email}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-500">Account Status</label>
                                    <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                                        parent.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'
                                    }">
                                        ${parent.is_active ? 'Active' : 'Inactive'}
                                    </span>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-500">Member Since</label>
                                    <p class="text-gray-900">${new Date(parent.created_at).toLocaleDateString()}</p>
                                </div>
                                <div>
                                    <label class="text-sm font-medium text-gray-500">Parent ID</label>
                                    <p class="text-gray-900 font-mono">${parent.id}</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Students Information -->
                        <div class="bg-gray-50 rounded-lg p-4">
                            <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                                <i class="fas fa-child mr-2 text-green-600"></i>
                                Associated Students (${students.length})
                            </h4>
                            ${students.length > 0 ? `
                                <div class="space-y-3">
                                    ${students.map(student => `
                                        <div class="bg-white rounded-lg p-3 border">
                                            <div class="flex items-center justify-between">
                                                <div>
                                                    <h5 class="font-medium text-gray-900">${student.first_name} ${student.last_name}</h5>
                                                    <p class="text-sm text-gray-500">Student ID: ${student.student_id}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-sm font-medium text-gray-900">${student.class_name}</p>
                                                    <p class="text-xs text-gray-500">Class ID: ${student.class_id}</p>
                                                </div>
                                            </div>
                                            ${student.date_of_birth ? `
                                                <div class="mt-2 text-xs text-gray-500">
                                                    <i class="fas fa-birthday-cake mr-1"></i>
                                                    Born: ${new Date(student.date_of_birth).toLocaleDateString()}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <p class="text-gray-500 text-center py-4">No students associated with this parent.</p>
                            `}
                        </div>
                    </div>
                `;
            } else {
                modalContent.innerHTML = `
                    <div class="text-center py-8">
                        <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Error Loading Parent Details</h3>
                        <p class="text-gray-500">${data.error}</p>
                        <button onclick="closeParentModal()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                            Close
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error loading parent details:', error);
            modalContent.innerHTML = `
                <div class="text-center py-8">
                    <i class="fas fa-exclamation-triangle text-4xl text-red-500 mb-4"></i>
                    <h3 class="text-lg font-medium text-gray-900 mb-2">Error Loading Parent Details</h3>
                    <p class="text-gray-500">Failed to load parent details. Please try again.</p>
                    <button onclick="closeParentModal()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700">
                        Close
                    </button>
                </div>
            `;
        });
}

function deleteParent(parentId) {
    if (confirm('Are you sure you want to delete this parent account? This action cannot be undone and will remove the parent\'s access to the system.')) {
        const button = event.target.closest('button');
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        button.disabled = true;
        
        fetch(`/api/teacher/parent/${parentId}/delete`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showNotification(data.message, 'success');
                // Remove the parent row from the table
                const parentRow = document.querySelector(`tr[data-parent-id="${parentId}"]`);
                if (parentRow) {
                    parentRow.remove();
                }
                // Check if no parents left
                const tbody = document.querySelector('tbody');
                if (tbody && tbody.children.length === 0) {
                    location.reload(); // Reload to show "no parents" message
                }
            } else {
                showNotification('Error: ' + data.error, 'error');
            }
        })
        .catch(error => {
            console.error('Error deleting parent:', error);
            showNotification('Error deleting parent: ' + error.message, 'error');
        })
        .finally(() => {
            button.innerHTML = originalHTML;
            button.disabled = false;
        });
    }
}

function closeParentModal() {
    const modal = document.getElementById('parentViewModal');
    modal.classList.add('hidden');
}

function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-sm ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${
                type === 'success' ? 'fa-check-circle' :
                type === 'error' ? 'fa-exclamation-circle' :
                type === 'warning' ? 'fa-exclamation-triangle' :
                'fa-info-circle'
            } mr-2"></i>
            <span>${message}</span>
            <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-white hover:text-gray-200">
                <i class="fas fa-times"></i>
            </button>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
}

// SMIED Assistant Functions
function openSMIEDAssistant() {
    const chatbot = document.getElementById('smiEDChatbot');
    if (chatbot) {
        chatbot.classList.remove('hidden');
        chatbot.classList.add('flex');
        document.getElementById('smiEDInput').focus();
    }
}

function toggleSMIEDChatbot() {
    const chatbot = document.getElementById('smiEDChatbot');
    if (chatbot) {
        if (chatbot.classList.contains('hidden')) {
            chatbot.classList.remove('hidden');
            chatbot.classList.add('flex');
            document.getElementById('smiEDInput').focus();
        } else {
            chatbot.classList.add('hidden');
            chatbot.classList.remove('flex');
        }
    }
}

function askSMIEDQuestion(question) {
    document.getElementById('smiEDInput').value = question;
    sendSMIEDMessage(new Event('submit'));
}

function sendSMIEDMessage(event) {
    event.preventDefault();
    
    const input = document.getElementById('smiEDInput');
    const message = input.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addSMIEDMessage(message, 'user');
    
    // Clear input
    input.value = '';
    
    // Disable send button and show typing indicator
    const sendButton = document.getElementById('smiEDSend');
    sendButton.disabled = true;
    showSMIEDTypingIndicator();
    
    // Send to AI API
    fetch('/api/teacher/ai-chatbot', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            message: message,
            context: 'Teacher Dashboard - General Teaching Assistance'
        })
    })
    .then(response => response.json())
    .then(data => {
        hideSMIEDTypingIndicator();
        sendButton.disabled = false;
        
        if (data.success && data.response) {
            addSMIEDMessage(data.response, 'ai');
        } else if (data.status && data.result && data.result.length > 0) {
            addSMIEDMessage(data.result[0], 'ai');
        } else {
            addSMIEDMessage('Sorry, I encountered an error. Please try again.', 'ai');
        }
    })
    .catch(error => {
        hideSMIEDTypingIndicator();
        sendButton.disabled = false;
        addSMIEDMessage('Sorry, I\'m having trouble connecting. Please check your internet connection and try again.', 'ai');
        console.error('SMIED Chatbot error:', error);
    });
}

function addSMIEDMessage(text, sender) {
    const messagesContainer = document.getElementById('smiEDMessages');
    
    // Remove suggested questions after first user message
    if (sender === 'user') {
        const suggestedQuestions = messagesContainer.querySelector('.space-y-3');
        if (suggestedQuestions && suggestedQuestions.querySelector('h4')) {
            suggestedQuestions.remove();
        }
    }
    
    const messageDiv = document.createElement('div');
    messageDiv.className = `flex items-start space-x-3 ${sender === 'user' ? 'flex-row-reverse space-x-reverse' : ''}`;
    
    const avatar = document.createElement('div');
    avatar.className = `w-8 h-8 rounded-full flex items-center justify-center flex-shrink-0 ${
        sender === 'user' 
            ? 'bg-indigo-500 text-white' 
            : 'bg-indigo-100 text-indigo-600'
    }`;
    avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user text-xs"></i>' : '<i class="fas fa-robot text-xs"></i>';
    
    const content = document.createElement('div');
    content.className = `rounded-2xl px-4 py-3 shadow-sm border max-w-md ${
        sender === 'user'
            ? 'bg-indigo-500 text-white rounded-tr-md'
            : 'bg-white text-gray-800 border-gray-100 rounded-tl-md'
    }`;
    content.innerHTML = `<div class="text-sm leading-relaxed">${formatSMIEDMessage(text)}</div>`;
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    
    messagesContainer.appendChild(messageDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function formatSMIEDMessage(text) {
    // Professional formatting for SMIED responses
    let formattedText = text
        // Clean up the response
        .replace(/^Hello! I'm SMIED, your AI teaching assistant\. I'd be delighted to help\.\s*/g, '')
        .replace(/^I'm SMIED, your AI teaching assistant\. I'm here to help with educational content, lesson planning, and teaching support\.\s*/g, '')
        .replace(/^Good day! I'm SMIED, your AI teaching assistant\. I'm functioning properly and ready to assist with educational content\.\s*/g, '')
        
        // Format headers properly
        .replace(/\*\*(.*?)\*\*/g, '<strong class="font-semibold text-gray-900">$1</strong>')
        .replace(/\*(.*?)\*/g, '<em class="italic text-gray-700">$1</em>')
        
        // Format lists
        .replace(/^•\s*(.+)$/gm, '<li class="ml-4 mb-1">• $1</li>')
        .replace(/^-\s*(.+)$/gm, '<li class="ml-4 mb-1">• $1</li>')
        .replace(/^(\d+)\.\s*(.+)$/gm, '<li class="ml-4 mb-1">$1. $2</li>')
        
        // Format sections with proper spacing
        .replace(/\n\n/g, '</p><p class="mb-3">')
        .replace(/\n/g, '<br>')
        
        // Wrap in paragraph tags
        .replace(/^(.+)$/, '<p class="mb-3">$1</p>')
        
        // Clean up empty paragraphs
        .replace(/<p class="mb-3"><\/p>/g, '')
        .replace(/<p class="mb-3"><br><\/p>/g, '');
    
    // Add professional styling wrapper
    return `<div class="prose prose-sm max-w-none text-gray-800 leading-relaxed">${formattedText}</div>`;
}

function showSMIEDTypingIndicator() {
    const messagesContainer = document.getElementById('smiEDMessages');
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'flex items-start space-x-3';
    typingDiv.id = 'smiEDTypingIndicator';
    
    const avatar = document.createElement('div');
    avatar.className = 'w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0';
    avatar.innerHTML = '<i class="fas fa-robot text-indigo-600 text-xs"></i>';
    
    const content = document.createElement('div');
    content.className = 'bg-white rounded-2xl rounded-tl-md px-4 py-3 shadow-sm border border-gray-100 max-w-xs';
    content.innerHTML = `
        <div class="flex items-center space-x-2 text-sm text-gray-600">
            <span>SMIED is thinking</span>
            <div class="flex space-x-1">
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full typing-dot"></div>
            </div>
        </div>
    `;
    
    typingDiv.appendChild(avatar);
    typingDiv.appendChild(content);
    
    messagesContainer.appendChild(typingDiv);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

function hideSMIEDTypingIndicator() {
    const typingIndicator = document.getElementById('smiEDTypingIndicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}
</script>

<!-- SMIED AI Assistant Toggle Button -->
<button class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-r from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 text-white rounded-full shadow-2xl hover:shadow-3xl transform hover:scale-110 transition-all duration-300 z-50 flex items-center justify-center text-2xl" onclick="toggleSMIEDChatbot()" title="SMIED AI Assistant">
    <i class="fas fa-robot"></i>
</button>

<!-- SMIED AI Assistant Widget -->
<div class="fixed bottom-6 right-6 w-96 h-[600px] bg-white rounded-2xl shadow-2xl z-50 hidden flex-col overflow-hidden border border-gray-200" id="smiEDChatbot">
    <!-- Header -->
    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 text-white p-4 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <div class="w-10 h-10 bg-white bg-opacity-20 rounded-full flex items-center justify-center">
                <i class="fas fa-robot text-lg"></i>
            </div>
            <div>
                <h3 class="font-semibold text-lg">SMIED AI Assistant</h3>
                <p class="text-xs text-indigo-100">Ready to help with your teaching</p>
            </div>
        </div>
        <button class="w-8 h-8 bg-white bg-opacity-20 hover:bg-opacity-30 rounded-full flex items-center justify-center transition-all duration-200" onclick="toggleSMIEDChatbot()">
            <i class="fas fa-times text-sm"></i>
        </button>
    </div>
    
    <!-- Messages Container -->
    <div class="flex-1 overflow-y-auto bg-gray-50 p-4 space-y-4" id="smiEDMessages">
        <!-- Welcome Message -->
        <div class="flex items-start space-x-3">
            <div class="w-8 h-8 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0">
                <i class="fas fa-robot text-indigo-600 text-sm"></i>
            </div>
            <div class="bg-white rounded-2xl rounded-tl-md px-4 py-3 shadow-sm border border-gray-100 max-w-xs">
                <p class="text-gray-800 text-sm leading-relaxed">Hello! I'm SMIED, your AI teaching assistant. I can help you with anything:</p>
                <ul class="text-xs text-gray-600 mt-2 space-y-1">
                    <li>• Complete lesson notes and content</li>
                    <li>• Learning objectives and activities</li>
                    <li>• Teaching strategies and methods</li>
                    <li>• Assessment questions and tools</li>
                    <li>• General questions and advice</li>
                    <li>• Any teaching-related topics</li>
                </ul>
                <p class="text-gray-800 text-sm mt-2">Ask me anything - I'm here to help with all your teaching needs!</p>
            </div>
        </div>
        
        <!-- Quick Questions -->
        <div class="space-y-3">
            <h4 class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Quick Questions</h4>
            <div class="flex flex-wrap gap-2">
                <button class="px-3 py-1.5 bg-blue-50 hover:bg-blue-100 text-blue-700 text-xs rounded-full border border-blue-200 transition-colors duration-200" onclick="askSMIEDQuestion('Give me a complete lesson note on Solar System for Basic 4')">
                    Solar System Lesson
                </button>
                <button class="px-3 py-1.5 bg-green-50 hover:bg-green-100 text-green-700 text-xs rounded-full border border-green-200 transition-colors duration-200" onclick="askSMIEDQuestion('How can I improve student engagement in my class?')">
                    Student Engagement
                </button>
                <button class="px-3 py-1.5 bg-purple-50 hover:bg-purple-100 text-purple-700 text-xs rounded-full border border-purple-200 transition-colors duration-200" onclick="askSMIEDQuestion('What are effective classroom management strategies?')">
                    Classroom Management
                </button>
                <button class="px-3 py-1.5 bg-orange-50 hover:bg-orange-100 text-orange-700 text-xs rounded-full border border-orange-200 transition-colors duration-200" onclick="askSMIEDQuestion('Help me create assessment questions for mathematics')">
                    Assessment Help
                </button>
                <button class="px-3 py-1.5 bg-red-50 hover:bg-red-100 text-red-700 text-xs rounded-full border border-red-200 transition-colors duration-200" onclick="askSMIEDQuestion('What are some creative teaching methods?')">
                    Teaching Methods
                </button>
                <button class="px-3 py-1.5 bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-xs rounded-full border border-indigo-200 transition-colors duration-200" onclick="askSMIEDQuestion('How do I handle difficult students?')">
                    Student Behavior
                </button>
            </div>
        </div>
    </div>
    
    <!-- Input Area -->
    <div class="p-4 bg-white border-t border-gray-200">
        <form class="flex items-center space-x-3" onsubmit="sendSMIEDMessage(event)">
            <div class="flex-1 relative">
                <input 
                    type="text" 
                    id="smiEDInput" 
                    placeholder="Ask SMIED anything - I'm here to help!" 
                    autocomplete="off"
                    class="w-full px-4 py-3 pr-12 bg-gray-50 border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent text-sm placeholder-gray-500"
                >
                <button 
                    type="submit" 
                    id="smiEDSend"
                    class="absolute right-2 top-1/2 transform -translate-y-1/2 w-8 h-8 bg-indigo-500 hover:bg-indigo-600 disabled:bg-gray-300 text-white rounded-full flex items-center justify-center transition-colors duration-200"
                >
                    <i class="fas fa-paper-plane text-xs"></i>
                </button>
            </div>
        </form>
    </div>
</div>

<style>
/* Custom animations for typing indicator */
@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
    }
    30% {
        transform: translateY(-10px);
    }
}

.typing-dot {
    animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dot:nth-child(3) {
    animation-delay: 0.4s;
}
</style>
{% endblock %}
