{% extends "base.html" %}

{% block title %}Edit Lesson - Teacher Dashboard{% endblock %}

{% block head %}
    {{ super() }}
    <script src="https://cdn.tiny.cloud/1/no-api-key/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        tinymce.init({
            selector: '#content, #lesson_notes',
            plugins: 'advlist autolink lists link image charmap print preview anchor searchreplace visualblocks code fullscreen insertdatetime media table paste code help wordcount',
            toolbar: 'undo redo | formatselect | bold italic backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | removeformat | help',
            height: 300
        });
    </script>
{% endblock %}

{% block content %}
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 sm:mb-8 space-y-2 sm:space-y-0">
    <h1 class="text-2xl sm:text-3xl font-bold text-gray-900 flex items-center">
        <i class="fas fa-edit mr-2 sm:mr-3"></i>Edit Lesson: {{ lesson.title }}
    </h1>
    <div class="flex space-x-2">
        <a href="{{ url_for('view_lesson', lesson_id=lesson.id) }}" class="bg-primary text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition duration-200 text-sm">
            <i class="fas fa-eye mr-1"></i>View Lesson
        </a>
        <a href="{{ url_for('teacher_lessons') }}" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600 transition duration-200 text-sm">
            <i class="fas fa-arrow-left mr-1"></i>Back to Lessons
        </a>
    </div>
</div>

<div class="bg-white rounded-xl shadow-lg p-6">
    <form method="POST" enctype="multipart/form-data" class="space-y-8">
        <!-- Basic Information -->
        <div class="border-b border-gray-200 pb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-info-circle mr-2 text-primary"></i>Basic Information
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="title" class="block text-sm font-medium text-gray-700 mb-2">Lesson Title *</label>
                    <input type="text" id="title" name="title" value="{{ lesson.title }}" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label for="subject_id" class="block text-sm font-medium text-gray-700 mb-2">Subject *</label>
                    <select id="subject_id" name="subject_id" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <option value="">Select Subject</option>
                        {% for subject in subjects %}
                        <option value="{{ subject.id }}" {% if lesson.subject_id == subject.id %}selected{% endif %}>{{ subject.name }} ({{ subject.class_obj.name }})</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="week" class="block text-sm font-medium text-gray-700 mb-2">Week *</label>
                    <select id="week" name="week" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <option value="">Select Week</option>
                        {% for i in range(1, 14) %}
                        <option value="Week {{ i }}" {% if lesson.week == 'Week ' + i|string %}selected{% endif %}>Week {{ i }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div>
                    <label for="term" class="block text-sm font-medium text-gray-700 mb-2">Term *</label>
                    <select id="term" name="term" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <option value="">Select Term</option>
                        <option value="First Term" {% if lesson.term == 'First Term' %}selected{% endif %}>First Term</option>
                        <option value="Second Term" {% if lesson.term == 'Second Term' %}selected{% endif %}>Second Term</option>
                        <option value="Third Term" {% if lesson.term == 'Third Term' %}selected{% endif %}>Third Term</option>
                    </select>
                </div>
                <div>
                    <label for="session" class="block text-sm font-medium text-gray-700 mb-2">Academic Session *</label>
                    <input type="text" id="session" name="session" value="{{ lesson.session }}" required class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label for="status" class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="status" name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <option value="planned" {% if lesson.status == 'planned' %}selected{% endif %}>Planned</option>
                        <option value="in_progress" {% if lesson.status == 'in_progress' %}selected{% endif %}>In Progress</option>
                        <option value="completed" {% if lesson.status == 'completed' %}selected{% endif %}>Completed</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Lesson Plan Section -->
        <div class="border-b border-gray-200 pb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-clipboard-list mr-2 text-indigo-500"></i>Lesson Plan
            </h2>
            <div class="space-y-6">
                <div>
                    <label for="objectives" class="block text-sm font-medium text-gray-700 mb-2">Learning Objectives</label>
                    <textarea id="objectives" name="objectives" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="What should students learn from this lesson?">{{ lesson.objectives or '' }}</textarea>
                </div>
                <div>
                    <label for="content" class="block text-sm font-medium text-gray-700 mb-2">Lesson Content</label>
                    <textarea id="content" name="content" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">{{ lesson.content or '' }}</textarea>
                </div>
                <div>
                    <label for="activities" class="block text-sm font-medium text-gray-700 mb-2">Activities</label>
                    <textarea id="activities" name="activities" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="What activities will students engage in?">{{ lesson.activities or '' }}</textarea>
                </div>
                <div>
                    <label for="resources" class="block text-sm font-medium text-gray-700 mb-2">Resources</label>
                    <textarea id="resources" name="resources" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="What materials and resources are needed?">{{ lesson.resources or '' }}</textarea>
                </div>
                <div>
                    <label for="assessment" class="block text-sm font-medium text-gray-700 mb-2">Assessment</label>
                    <textarea id="assessment" name="assessment" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="How will you assess student learning?">{{ lesson.assessment or '' }}</textarea>
                </div>
            </div>
        </div>

        <!-- Lesson Notes Section -->
        <div class="border-b border-gray-200 pb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-sticky-note mr-2 text-teal-500"></i>Lesson Notes
            </h2>
            <div class="space-y-6">
                <div>
                    <label for="lesson_notes" class="block text-sm font-medium text-gray-700 mb-2">Lesson Notes</label>
                    <textarea id="lesson_notes" name="lesson_notes" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">{{ lesson.lesson_notes or '' }}</textarea>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="student_attendance" class="block text-sm font-medium text-gray-700 mb-2">Student Attendance</label>
                        <textarea id="student_attendance" name="student_attendance" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="Track student attendance">{{ lesson.student_attendance or '' }}</textarea>
                    </div>
                    <div>
                        <label for="student_performance" class="block text-sm font-medium text-gray-700 mb-2">Student Performance</label>
                        <textarea id="student_performance" name="student_performance" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="Notes on student performance">{{ lesson.student_performance or '' }}</textarea>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label for="challenges" class="block text-sm font-medium text-gray-700 mb-2">Challenges</label>
                        <textarea id="challenges" name="challenges" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="What challenges were encountered?">{{ lesson.challenges or '' }}</textarea>
                    </div>
                    <div>
                        <label for="next_steps" class="block text-sm font-medium text-gray-700 mb-2">Next Steps</label>
                        <textarea id="next_steps" name="next_steps" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary" placeholder="What are the next steps for improvement?">{{ lesson.next_steps or '' }}</textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress and Dates -->
        <div class="border-b border-gray-200 pb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-chart-line mr-2 text-green-500"></i>Progress & Dates
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div>
                    <label for="completion_percentage" class="block text-sm font-medium text-gray-700 mb-2">Completion Percentage</label>
                    <input type="number" id="completion_percentage" name="completion_percentage" min="0" max="100" value="{{ lesson.completion_percentage }}" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label for="planned_date" class="block text-sm font-medium text-gray-700 mb-2">Planned Date</label>
                    <input type="date" id="planned_date" name="planned_date" value="{{ lesson.planned_date.strftime('%Y-%m-%d') if lesson.planned_date else '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                </div>
                <div>
                    <label for="taught_date" class="block text-sm font-medium text-gray-700 mb-2">Taught Date</label>
                    <input type="date" id="taught_date" name="taught_date" value="{{ lesson.taught_date.strftime('%Y-%m-%d') if lesson.taught_date else '' }}" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                </div>
            </div>
        </div>

        <!-- Attachments -->
        <div class="pb-6">
            <h2 class="text-xl font-semibold text-gray-900 mb-4 flex items-center">
                <i class="fas fa-paperclip mr-2 text-purple-500"></i>Attachments
            </h2>
            
            <!-- Existing Attachments -->
            {% if lesson.attachments %}
            <div class="mb-6">
                <h3 class="text-lg font-medium text-gray-900 mb-4">Current Attachments</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {% for attachment in lesson.attachments %}
                    <div class="border border-gray-200 rounded-lg p-4">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center">
                                <i class="fas fa-file mr-2 text-gray-500"></i>
                                <span class="text-sm font-medium text-gray-900">{{ attachment.original_filename }}</span>
                            </div>
                            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                                {{ attachment.attachment_type|title }}
                            </span>
                        </div>
                        <div class="text-xs text-gray-500 mb-2">
                            {{ attachment.file_type|upper }} • {{ "%.1f"|format(attachment.file_size / 1024) }} KB
                        </div>
                        <a href="{{ url_for('static', filename=attachment.file_path) }}" target="_blank" class="text-primary hover:text-blue-700 text-sm">
                            <i class="fas fa-download mr-1"></i>Download
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            <!-- Add New Attachments -->
            <div class="space-y-4">
                <div>
                    <label for="attachments" class="block text-sm font-medium text-gray-700 mb-2">Upload New Files (PDF, Word, TXT, RTF)</label>
                    <input type="file" id="attachments" name="attachments" multiple class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                    <p class="text-sm text-gray-500 mt-1">You can upload multiple files at once</p>
                </div>
                <div>
                    <label for="attachment_type" class="block text-sm font-medium text-gray-700 mb-2">Attachment Type</label>
                    <select id="attachment_type" name="attachment_type" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-primary focus:border-primary">
                        <option value="resource">Resource</option>
                        <option value="plan">Lesson Plan</option>
                        <option value="note">Lesson Note</option>
                        <option value="assessment">Assessment</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Form Actions -->
        <div class="flex justify-end space-x-3 pt-6 border-t border-gray-200">
            <a href="{{ url_for('view_lesson', lesson_id=lesson.id) }}" class="bg-gray-300 text-gray-700 px-6 py-2 rounded-lg hover:bg-gray-400 transition duration-200">
                Cancel
            </a>
            <button type="submit" class="bg-success text-white px-6 py-2 rounded-lg hover:bg-green-700 transition duration-200">
                <i class="fas fa-save mr-1"></i>Update Lesson
            </button>
        </div>
    </form>
</div>
{% endblock %}
